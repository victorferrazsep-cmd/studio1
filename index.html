<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/png" href="Assets/icon.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Studio Sa Lopes ‚ú®</title>

<!-- Tailwind CSS -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<!-- Signature Pad (para assinatura) -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- Manifest (PWA) -->
<link rel="manifest" href="manifest.json">

<!-- EmailJS -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    (function() {
      emailjs.init("hwdHL8qVI8eQDCAxB");
    })();
  </script>

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fadeIn {
    animation: fadeIn 0.25s ease;
  }

  /* Tema escuro do calend√°rio */
.fc {
  background-color: #1e1e1e;
  border-radius: 1rem;
  color: var(--rose);
  border: 1px solid #333;
}

.fc-daygrid-day-number,
.fc-toolbar-title {
  color: var(--rose);
  font-size: 0.75rem !important;
  font-weight: 300;
}

.fc-button {
  background: var(--rose) !important;
  border: none !important;
  color: #111 !important;
  font-weight: bold;
}

.fc-button:hover {
  background: #ffd2c2 !important;
}

.numero-grande {
  display: block;
  font-size: 2rem;      /* ajuste livre */
  font-weight: 300;    /* fino */
  line-height: 1.1;
}


:root {
    --fundo: #1e1e1e;
    --rose: #f4bfae;
    --texto: #ffffff;
  }

  body {
    background-color: var(--fundo);
    color: var(--texto);
    font-family: 'Inter', sans-serif;
  }

  .sidebar {
    background-color: #111111;
    color: var(--rose);
    transition: transform 0.3s ease;
  }
.card {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

  .sidebar a {
    display: block;
    padding: 12px 20px;
    border-radius: 8px;
    color: var(--rose);
    text-decoration: none;
    margin-bottom: 4px;
    transition: background 0.2s;
  }

  .sidebar a:hover, .sidebar a.active {
    background-color: var(--rose);
    color: #111111;
  }

  .sidebar.hidden { transform: translateX(-100%); }
  
  /* üîπ Classe hidden gen√©rica - garante que elementos s√£o escondidos */
  .hidden {
    display: none !important;
  }
  
  /* üîπ Classe para esconder a sidebar fora da tela */
  .sidebar-hidden {
    transform: translateX(-100%);
  }

  /*.sidebar.hidden { transform: translateX(-100%); }*/

  .card {
    background-color: #252525;
    color: var(--rose);
    border: 1px solid #3a3a3a;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 50;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    justify-content: center; align-items: center;
  }

  .modal-content {
    background: #2b2b2b;
    color: var(--rose);
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 800px;
    max-height: 90%;
    overflow-y: auto;
  }

  .btn-primary {
    background-color: var(--rose);
    color: #111;
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    background-color: #ffd2c2;
  }

.card-footer {
  background: linear-gradient(to bottom, #b88c7a, #f4bfae);
  box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
  cursor: pointer;
  overflow: hidden;
  transition: all 0.4s ease;
  max-height: 12px; /* apenas a barrinha vis√≠vel inicialmente */

  position: relative;
  z-index: 1;         /* üîπ fica por baixo do card */
  margin-top: -14px;  /* üîπ empurra para tr√°s do card */
}

.card-footer.open {
  max-height: 200px; /* altura expandida ao abrir */
  padding: 10px;
}

.card-footer-content {
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.4s ease;
}

.card-footer.open .card-footer-content {
  opacity: 1;
  transform: translateY(0);
}

.cliente-card {
  position: relative;
  z-index: 5; /* üîπ card acima da faixa */
  background-color: #2b2b2b;
  border-radius: 1rem;
  box-shadow:
    0 3px 8px rgba(0, 0, 0, 0.45),
  /*transition: all 0.3s ease;*/
}

.cliente-card:hover {
  box-shadow:
    0 5px 14px rgba(0, 0, 0, 0.6),
    inset 0 0 10px rgba(12, 12, 12, 0.15);
  transform: translateY(-2px);
  background-color: #2f2f2f;
}




</style>
</head>
<body class="flex h-screen">

<!-- Sidebar -->
<aside id="sidebar" class="sidebar w-64 p-5 pt-8 flex flex-col fixed inset-y-0 left-0 z-40 sidebar-hidden">
  <h1 class="text-2x1 font-semibold mb-8 text-center">Menu</h1>
  <nav class="flex flex-col space-y-2">
    <a href="#" class="active" data-page="home">Home</a>
    <a href="#" data-page="clientes">Clientes</a>
    <a href="#" data-page="agenda">Agenda</a>
    <a href="#" data-page="financeiro2">Financeiro</a>
  </nav>
</aside>

<!-- Bot√£o de menu -->
<button id="menuBtn" class="absolute top-5 left-5 p-2 rounded-md shadow-md z-50">
  <span style="color: var(--rose);" class="text-2xl">‚ò∞</span>
</button>

<!-- Conte√∫do principal -->
<main class="flex-1 p-10 overflow-y-auto ml-0">

  <!-- HOME -->
  <div id="homePage" class="page">
    <div class="text-center mb-8">
      <img src="Assets/logo.png" alt="Logo Studio Sa Lopes" class="mx-auto mb-4" style="width:320px;" onerror="this.onerror=null;">
      <h2 class="text-3xl font-bold text-rose-300" style="display:none;">Gest√£o Studio Sa Lopes</h2>
    </div>

<div class="grid grid-cols-4 gap-5 mb-5">

<div class="card px-4 py-4 rounded-xl shadow-[0_0_8px_rgba(0,0,0,0.15)] grid grid-rows-2 text-center text-sm">
  <div id="agendamentos" class="font-semibold" style="color:#F8C6AF">
    <div style="font-size:5em; line-height:1;"></div>
    <div>Agendamentos</div>
  </div>

  <div class="text-xs italic" style="color:#7F7F7F">
    Confirmadas
  </div>
</div>


  <!-- Caixa 2 -->
  <div class="card px-4 py-4 rounded-xl shadow-[0_0_8px_rgba(0,0,0,0.15)] grid grid-rows-2 text-center text-sm">
    <div id="atendimentos" class="font-semibold" style="color:#F8C6AF">
      Atendimentos
    </div>
    <div class="text-xs italic" style="color:#7F7F7F">
      Atendidas
    </div>
  </div>

  <!-- Caixa 3 -->
  <div class="card px-4 py-4 rounded-xl shadow-[0_0_8px_rgba(0,0,0,0.15)] grid grid-rows-2 text-center text-sm">
    <div id="ciliosTotal" class="font-semibold" style="color:#F8C6AF">
      C√≠lios
    </div>
    <div id="ciliosDetalhe" class="text-xs italic" style="color:#7F7F7F">
      Aplic.: - | Manut.: -
    </div>
  </div>

  <!-- Caixa 4 -->
  <div class="card px-4 py-4 rounded-xl shadow-[0_0_8px_rgba(0,0,0,0.15)] grid grid-rows-2 text-center text-sm">
    <div id="sobraTotal" class="font-semibold" style="color:#F8C6AF">
      Sobrancelhas
    </div>
    <div id="sobraDetalhe" class="text-xs italic" style="color:#7F7F7F">
      Aplic.: - | Manut.: -
    </div>
  </div>
</div>


<div class="card rounded-xl shadow p-5 mb-5">
  <div id="calendar" class="w-full"></div>
</div>

<div class="card rounded-xl shadow p-5 flex flex-col justify-center" id="resumoFinanceiro">
  <h3 class="text-lg font-bold mb-4">üí∞ Resumo Financeiro</h3>
  <div class="grid grid-cols-3 gap-5">
    <div class="card p-4 rounded-xl shadow text-center bg-[#2b2b2b] text-white" id="resumoReceita">
      <h4 class="font-semibold mb-2">‚ÜóÔ∏è Ganhos</h4>
                <p class="text-2xl">R$ 0,00</p>
    </div>
    <div class="card p-4 rounded-xl shadow text-center bg-[#2b2b2b] text-white" id="resumoDespesa">
      <h4 class="font-semibold mb-2">‚ÜòÔ∏è Despesas</h4>
      <p class="text-2xl">R$ 0,00</p>
    </div>
    <div class="card p-4 rounded-xl shadow text-center bg-[#2b2b2b] text-white" id="resumoSaldo">
      <h4 class="font-semibold mb-2">üíµ Saldo</h4>
      <p class="text-2xl">R$ 0,00</p>
    </div>
  </div>
</div>
</div>

    <!-- CLIENTES -->
  <div id="clientesPage" class="page hidden">
    <div class="flex justify-between mb-5 items-center">
      <h2 class="text-2xl font-bold text-rose-300 ml-6 -mt-8">Clientes ‚ú®</h2>
      <button id="btnAdicionarCliente" class="btn-primary px-4 py-2 rounded-md mr-4">Adicionar Cliente</button>
    </div>
    <div class="mb-5 ml-4">
      <label class="block mb-2 font-semibold text-rose-300">Filtro por Status:</label>
      <div class="flex gap-4">
        <label class="flex items-center">
          <input type="radio" name="filtroStatus" value="todos" checked class="mr-2">
          Todos
        </label>
        <label class="flex items-center">
          <input type="radio" name="filtroStatus" value="Ativo" class="mr-2">
          Ativo
        </label>
        <label class="flex items-center">
          <input type="radio" name="filtroStatus" value="Inativo" class="mr-2">
          Inativo
        </label>
      </div>
    </div>
<!-- Formul√°rio de Cliente (MODAL) -->
<!-- üîπ Modal de Cadastro de Cliente com anima√ß√£o -->
<div id="boxCliente"
  class="hidden fixed inset-0 z-50 flex items-center justify-center transition-all duration-300">

  <!-- Fundo escurecido e emba√ßado -->
  <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-filter transition-opacity duration-300"
       style="backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);"></div>

  <!-- Conte√∫do do formul√°rio -->
  <div id="boxClienteContent"
       class="card relative rounded-xl shadow-lg p-6 w-full max-w-xl mx-auto bg-[#2b2b2b]/95 border border-rose-300 z-10
              transform scale-95 opacity-0 transition-all duration-300">
    
    <h2 id="tituloCliente" class="text-xl font-bold mb-4 text-center text-rose-300">
      Cadastro de Cliente
    </h2>

    <form id="formCliente" class="space-y-4">
      <div>
        <label class="block mb-1 font-semibold" for="clienteNome">NOME</label>
        <input type="text" id="clienteNome" name="Nome"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
      </div>

      <div>
        <label class="block mb-1 font-semibold" for="clienteCpf">CPF</label>
        <input type="text" id="clienteCpf" name="CPF"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
      </div>

      <div>
        <label class="block mb-1 font-semibold" for="clienteTelefone">TELEFONE</label>
        <input type="text" id="clienteTelefone" name="Telefone"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
      </div>

      <div>
        <label class="block mb-1 font-semibold" for="clienteDn">DN</label>
        <input type="date" id="clienteDn" name="DN"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
      </div>

      <div>
        <label class="block mb-1 font-semibold" for="clienteEnderecoNum">ENDERE√áO</label>
        <input type="text" id="clienteEnderecoNum" name="Endereco"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
      </div>

      <div>
        <label class="block mb-1 font-semibold" for="clienteCep">E-MAIL</label>
        <input type="text" id="clienteCep" name="CEP"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
      </div>

      <div>
        <label class="block mb-1 font-semibold" for="clienteInstagram">INSTAGRAM</label>
        <input type="text" id="clienteInstagram" name="Instagram"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300">
      </div>

      <div>
        <label class="block mb-1 font-semibold" for="clienteStatus">STATUS</label>
        <select id="clienteStatus" name="Status"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
          <option value="Ativo">Ativo</option>
          <option value="Inativo">Inativo</option>
        </select>
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button type="button" id="fecharBoxCliente"
          class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">Fechar</button>
        <button type="submit"
  class="px-4 py-2 rounded-md font-semibold transition-all"
  style="
    background-color: var(--rose);
    color: #000;
    box-shadow: 0 0 10px rgba(244, 191, 174, 0.6);
  ">
  Salvar
</button>

      </div>
    </form>
  </div>
</div>


    <div class="mt-6 ml-4">
      <div id="listaClientes" class="space-y-4">
      </div>
    </div>
  </div>

  <!-- AGENDA -->
  <div id="agendaPage" class="page hidden">
    <div class="flex justify-between mb-5 items-center">
      <h2 class="text-2xl font-bold text-rose-300 ml-6 -mt-3">Agenda ‚ú®</h2>
      <!-- O bot√£o de presen√ßa foi removido daqui -->
    </div>

<div class="grid grid-cols-4 gap-5 mb-5">

  <!-- Caixa 1 -->
  <div class="card px-4 py-4 rounded-xl shadow-[0_0_8px_rgba(0,0,0,0.15)] grid grid-rows-2 text-center text-sm">
    <div id="agendaAgendamentos" class="font-semibold" style="color:#F8C6AF">
      Agendamentos
    </div>
    <div class="text-xs italic" style="color:#7F7F7F">
      Confirmadas
    </div>
  </div>

  <!-- Caixa 2 -->
  <div class="card px-4 py-4 rounded-xl shadow-[0_0_8px_rgba(0,0,0,0.15)] grid grid-rows-2 text-center text-sm">
    <div id="agendaAtendimentos" class="font-semibold" style="color:#F8C6AF">
      Atendimentos
    </div>
    <div class="text-xs italic" style="color:#7F7F7F">
      Atendidas
    </div>
  </div>

  <!-- Caixa 3 -->
  <div class="card px-4 py-4 rounded-xl shadow-[0_0_8px_rgba(0,0,0,0.15)] grid grid-rows-2 text-center text-sm">
    <div id="agendaCiliosTotal" class="font-semibold" style="color:#F8C6AF">
      C√≠lios
    </div>
    <div id="agendaCiliosDetalhe" class="text-xs italic" style="color:#7F7F7F">
      Aplic.: - | Manut.: -
    </div>
  </div>

  <!-- Caixa 4 -->
  <div class="card px-4 py-4 rounded-xl shadow-[0_0_8px_rgba(0,0,0,0.15)] grid grid-rows-2 text-center text-sm">
    <div id="agendaSobraTotal" class="font-semibold" style="color:#F8C6AF">
      Sobrancelhas
    </div>
    <div id="agendaSobraDetalhe" class="text-xs italic" style="color:#7F7F7F">
      Aplic.: - | Manut.: -
    </div>
  </div>

</div>


<!-- Calend√°rio -->
<div class="card rounded-xl shadow p-5 mb-5 relative overflow-hidden">
  <div id="calendarAgenda" class="w-full" style="height: 400px;"></div>
</div>

<!-- üîπ Modal de Agendamento (mesmo layout do boxCliente) -->
<div id="modalAgendamento"
  class="hidden fixed inset-0 z-50 flex items-center justify-center transition-all duration-300">

  <!-- Fundo escurecido e emba√ßado -->
  <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-filter transition-opacity duration-300"
       style="backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);"></div>

  <!-- Conte√∫do do formul√°rio -->
  <div id="modalAgendamentoContent"
       class="card relative rounded-xl shadow-lg p-6 w-full max-w-xl mx-auto bg-[#2b2b2b]/95 border border-rose-300 z-10
              transform scale-95 opacity-0 transition-all duration-300">
    
    <h2 class="text-xl font-bold mb-4 text-center text-rose-300">
      Agendamento
    </h2>

    <form id="formAgendamento" class="space-y-4">
      <!-- Container para checkboxes de e-mail e presen√ßa -->
      <div class="flex justify-between items-center">
        <label class="flex items-center gap-2 text-sm text-gray-300">
          <input type="checkbox" id="enviarEmail" checked />
          Enviar e-mail para a cliente
        </label>
        <div id="campoPresenca" class="hidden">
          <label class="flex items-center gap-2 cursor-pointer text-sm">
            <input type="checkbox" id="agendamentoPresenca" class="h-4 w-4 rounded text-green-500 bg-gray-700 border-gray-600 focus:ring-green-600 ring-offset-gray-800 focus:ring-2">
            <span class="font-semibold text-rose-300">Presen√ßa</span>
          </label>
        </div>
      </div>
      <div>
        <label class="block mb-1 font-semibold" for="agendamentoCliente">CLIENTE</label>
        <select id="agendamentoCliente" name="Cliente"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
          <option value="">Selecione um cliente</option>
        </select>
      </div>

      <div>
        <label class="block mb-1 font-semibold" for="agendamentoCep">E-MAIL</label>
        <input type="text" id="agendamentoCep" name="CEP"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" readonly>
      </div>

      <div>
        <label class="block mb-1 font-semibold" for="agendamentoData">DATA</label>
        <input type="date" id="agendamentoData" name="Data"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
      </div>

      <div>
        <label class="block mb-1 font-semibold" for="agendamentoHora">HORA</label>
        <input type="time" id="agendamentoHora" name="Hora"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
      </div>

      <div>
        <label class="block mb-1 font-semibold" for="agendamentoModalidade">MODALIDADE</label>
        <select id="agendamentoModalidade" name="Modalidade"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
          <option value="">Selecione a modalidade</option>
          <option value="Extens√£o de C√≠lios">Extens√£o de C√≠lios</option>
          <option value="Sobrancelhas">Sobrancelhas</option>
        </select>
      </div>

      <div>
        <label class="block mb-1 font-semibold" for="agendamentoProcedimento">PROCEDIMENTO</label>
        <select id="agendamentoProcedimento" name="Procedimento"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
          <option value="">Selecione o procedimento</option>
          <option value="Aplica√ß√£o">Aplica√ß√£o</option>
          <option value="Manuten√ß√£o">Manuten√ß√£o</option>
        </select>
      </div>

      <div>
        <label class="block mb-1 font-semibold" for="agendamentoTipo">TIPO</label>
        <input type="text" id="agendamentoTipo" name="Tipo"
          class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300">
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button type="button" id="fecharModalAgendamento"
          class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">Fechar</button>
        <button type="button" id="btnExcluirAgendamento"
          class="bg-red-700 hover:bg-red-800 text-white px-4 py-2 rounded-md hidden">Excluir</button>


        <button type="submit"
          class="px-4 py-2 rounded-md font-semibold transition-all"
          style="
            background-color: var(--rose);
            color: #000;
            box-shadow: 0 0 10px rgba(244, 191, 174, 0.6);
          ">
          <span id="btnSalvarAgendamentoTexto">Agendar</span>
        </button>
      </div>
    </form>
  </div>
</div>

</div>

 <!-- üîπ MODAL DE ANAMNESE -->
<div
  id="modalAnamnese"
  class="hidden fixed inset-0 z-[9999] bg-black/70 backdrop-blur-sm"
    style="z-index: 99999;"
>
  <!-- Container de scroll -->
  <div
    class="w-full h-full overflow-y-auto flex justify-center items-start p-4 touch-pan-y"
  >
      <!-- Fundo -->
      <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-filter transition-opacity duration-300" style="backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);"></div>

      <!-- Conte√∫do -->
      <div id="modalAnamneseContent" class="card relative rounded-xl shadow-lg p-6 w-full max-w-2xl mx-auto bg-[#2b2b2b]/95 border border-rose-300 z-10 opacity-0 transition-all duration-300 max-h-[90vh] overflow-y-auto">
        <h2 class="text-xl font-bold mb-4 text-center text-rose-300">Ficha de Anamnese</h2>
        <form id="formAnamnese" class="space-y-4">

          <!-- BLOCO 1: Dados da Cliente -->
          <fieldset class="border border-gray-600 p-3 rounded-lg">
            <legend class="px-2 font-semibold text-rose-300">Dados da Cliente</legend>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <input type="hidden" id="anamneseData" name="Data">
              <div><strong class="text-gray-400">Nome:</strong> <span id="anamneseNome"></span></div>
              <div><strong class="text-gray-400">CPF:</strong> <span id="anamneseCpf"></span></div>
              <div><strong class="text-gray-400">Telefone:</strong> <span id="anamneseTelefone"></span></div>
              <div><strong class="text-gray-400">DN:</strong> <span id="anamneseDn"></span></div>
            </div>
          </fieldset>

          <!-- BLOCO 2: Avalia√ß√£o -->
          <fieldset class="border border-gray-600 p-3 rounded-lg">
            <legend class="px-2 font-semibold text-rose-300">Avalia√ß√£o</legend>
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <span>1¬™ Vez que aplica os c√≠lios?</span>
                <div class="flex gap-4"><label><input type="radio" name="Prim_Vez" value="Sim" class="mr-1">Sim</label><label><input type="radio" name="Prim_Vez" value="N√£o" class="mr-1">N√£o</label></div>
              </div>
              <div class="flex items-center justify-between">
                <span>Est√° de R√≠mel?</span>
                <div class="flex gap-4"><label><input type="radio" name="Rimel" value="Sim" class="mr-1">Sim</label><label><input type="radio" name="Rimel" value="N√£o" class="mr-1">N√£o</label></div>
              </div>
              <div class="flex items-center justify-between">
                <span>Possui Alergia?</span>
                <div class="flex gap-4"><label><input type="radio" name="Alergia" value="Sim" class="mr-1">Sim</label><label><input type="radio" name="Alergia" value="N√£o" class="mr-1">N√£o</label></div>
              </div>
              <div id="campoAlergiaQuais" class="hidden"><input type="text" name="Alergia_Quais" placeholder="Quais alergias?" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300"></div>
              <div class="flex items-center justify-between">
                <span>Est√° gestante?</span>
                <div class="flex gap-4"><label><input type="radio" name="Gestante" value="Sim" class="mr-1">Sim</label><label><input type="radio" name="Gestante" value="N√£o" class="mr-1">N√£o</label></div>
              </div>
              <div class="flex items-center justify-between">
                <span>Dorme de lado?</span>
                <div class="flex gap-4"><label><input type="radio" name="Dorme" value="Direito" class="mr-1">Direito</label><label><input type="radio" name="Dorme" value="Esquerdo" class="mr-1">Esquerdo</label><label><input type="radio" name="Dorme" value="N√£o" class="mr-1">N√£o</label></div>
              </div>
              <div class="flex items-center justify-between">
                <span>Algum problema ocular?</span>
                <div class="flex gap-4"><label><input type="radio" name="Doenca" value="Sim" class="mr-1">Sim</label><label><input type="radio" name="Doenca" value="N√£o" class="mr-1">N√£o</label></div>
              </div>
              <div id="campoDoencaQuais" class="hidden"><input type="text" name="Doenca_Quais" placeholder="Quais problemas?" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300"></div>
              <div>
                <label class="block mb-1">Existe algum problema que julgue necess√°rio informar?</label>
                <textarea name="Obs" rows="2" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300"></textarea>
              </div>
            </div>
          </fieldset>

          <!-- BLOCO 3: Aceite e Assinatura -->
          <fieldset class="border border-gray-600 p-3 rounded-lg">
            <legend class="px-2 font-semibold text-rose-300">Termo de Consentimento</legend>
            <p class="text-xs italic text-gray-400 mb-2">"Autorizo a realiza√ß√£o do procedimento de alongamento de c√≠lios. Autorizo o registro fotogr√°fico do "antes e depois" para documenta√ß√£o e divulga√ß√£o da profissional. As declara√ß√µes acima s√£o verdadeiras, n√£o cabendo ao profissional a responsabilidade por informa√ß√µes omitidas nesta avalia√ß√£o. Me comprometo a seguir todos os cuidados necess√°rios ap√≥s o procedimento."</p>
            <div class="relative w-full h-32 bg-gray-200 rounded-md">
              <canvas id="signature-pad" class="absolute top-0 left-0 w-full h-full"></canvas>
            </div>
            <button type="button" id="clear-signature" class="text-xs text-gray-400 hover:text-white mt-1">Limpar Assinatura</button>
            <input type="hidden" name="Assinatura" id="assinaturaOutput">
          </fieldset>

          <!-- BLOCO 4: Procedimento Realizado -->
          <fieldset class="border border-gray-600 p-3 rounded-lg">
            <legend class="px-2 font-semibold text-rose-300">Procedimento Realizado</legend>
            <div class="grid grid-cols-2 gap-4">
              <input type="hidden" name="Procedimento" id="anamneseProcedimento">
              <div><label class="block mb-1 font-semibold">Modalidade</label><input type="text" id="anamneseModalidade" name="Modalidade" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-gray-400" readonly></div>
              <div><label class="block mb-1 font-semibold">T√©cnica</label><input type="text" name="Tecnica" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-gray-400"></div>
              <div><label class="block mb-1 font-semibold">Mapping</label><input type="text" name="Mapping" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-gray-400"></div>
              <div><label class="block mb-1 font-semibold">Tamanho</label><input type="text" name="Tamanho" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-gray-400"></div>
              <div><label class="block mb-1 font-semibold">Curvatura</label><input type="text" name="Curvatura" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-gray-400"></div>
              <div><label class="block mb-1 font-semibold">Espessura</label><input type="text" name="Espessura" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-gray-400"></div>
              <div><label class="block mb-1 font-semibold">Adesivo</label><input type="text" name="Adesivo_Cola" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-gray-400"></div>
              <div><label class="block mb-1 font-semibold">Hor√°rio de In√≠cio</label><input type="text" id="anamneseHorarioInicio" name="Horario_Inicio" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-gray-400" readonly></div>
            </div>
          </fieldset>

          <div class="flex justify-end gap-3 mt-6">
            <button type="button" id="fecharModalAnamnese" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">Fechar</button>
            <button type="submit" class="px-4 py-2 rounded-md font-semibold transition-all" style="background-color: var(--rose); color: #000; box-shadow: 0 0 10px rgba(244, 191, 174, 0.6);">Salvar Anamnese</button>
          </div>
        </form>
      </div>
    </div>
    </div>

    <!-- FINANCEIRO 2 --> 
    <div id="financeiro2Page" class="page hidden">
<div class="flex justify-between mb-5 items-center">
  <h2 class="text-2xl font-bold text-rose-300 ml-6 -mt-8">Financeiro ‚ú®</h2>
  <div class="flex gap-3 mr-4">
    <button id="btnAdicionarOcorrencia" class="btn-primary px-4 py-2 rounded-md">+ Ocorr√™ncia</button>
    <button id="btnLoadRelatorio" class="btn-primary px-4 py-2 rounded-md">Relat√≥rio</button>
  </div>
</div>
      <div id="boxFinanceiro2" class="card rounded-xl shadow p-5 max-w-xl mx-auto hidden">
        <form id="formFinanceiro2" class="space-y-4" action="https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc" method="post">
          <div>
            <label class="block mb-1 font-semibold" for="financeiroDtRegistro">Data de Registro</label>
            <input type="date" id="financeiroDtRegistro" name="DtRegistro" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
          </div>

          <div>
            <label class="block mb-1 font-semibold" for="financeiroTipo">Tipo</label>
            <select id="financeiroTipo" name="Tipo" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
              <option value="" disabled selected>Selecione o Tipo</option>
              <option value="Despesas">Despesas</option>
              <option value="Ganhos">Ganhos</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 font-semibold" for="financeiroFamilia">Fam√≠lia</label>
            <select id="financeiroFamilia" name="Familia" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required disabled>
              <option value="" disabled selected>Selecione a Fam√≠lia</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 font-semibold" for="financeiroNome">Nome</label>
            <select id="financeiroNome" name="Nome" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required disabled>
              <option value="" disabled selected>Selecione o Nome</option>
            </select>
          </div>

          <div>
            <label class="block mb-1 font-semibold" for="financeiroDescricao">Descri√ß√£o</label>
            <input type="text" id="financeiroDescricao" name="Descricao" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
          </div>
          <div>
            <label class="block mb-1 font-semibold" for="financeiroValor">Valor</label>
            <input type="number" id="financeiroValor" name="Valor" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
          </div>
          <div>
<label class="block mb-1 font-semibold" for="financeiroMesRef">M√™s de Refer√™ncia</label>
<input type="month" id="financeiroMesRef" name="MesRef" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
          </div>
          <div class="flex justify-end gap-3 mt-6">
            <button type="button" id="fecharBoxFinanceiro2" class="btn-primary px-4 py-2 rounded-md">Fechar</button>
            <button type="submit" class="btn-primary px-4 py-2 rounded-md">Enviar</button>
          </div>
        </form>
      </div>
<div id="relatorioFinanceiro2" class="card rounded-xl shadow p-5 mx-auto mt-6" style="width: 100%; display: flex; flex-direction: column; gap: 1rem;">
        <h3 class="text-xl font-bold mb-4 text-rose-300 flex justify-between items-center">
          Relat√≥rio Financeiro
<input type="month" 
       id="relatorioMesSelector" 
       class="bg-[#1e1e1e] border border-rose-300 rounded p-1 text-xs text-black w-[130px]" 
       title="Selecione o m√™s">
                                                                                                                                        

        </h3>
<div id="relatorioDashboard" class="grid grid-cols-3 gap-4 mb-4 max-w-full">
          <div class="card p-4 rounded-xl shadow text-center bg-[#2b2b2b] text-white">
            <h4 class="font-semibold mb-2">Ganhos</h4>
            <p id="dashboardReceita" class="text-2xl">R$0</p>
          </div>
          <div class="card p-4 rounded-xl shadow text-center bg-[#2b2b2b] text-white">
            <h4 class="font-semibold mb-2">Despesas</h4>
            <p id="dashboardDespesa" class="text-2xl">R$0</p>
          </div>
          <div class="card p-4 rounded-xl shadow text-center bg-[#2b2b2b] text-white">
            <h4 class="font-semibold mb-2">Saldo</h4>
            <p id="dashboardSaldo" class="text-2xl">R$0</p>
          </div>
        </div>

<div id="relatorioResumoDetalhado" class="bg-[#2b2b2b] text-white p-4 rounded-xl shadow w-full mb-2 font-mono whitespace-pre-wrap" style="font-size: 0.85rem; max-height: 800px; overflow-y: auto;"></div>
<button id="toggleRelatorioBtn" style="display:none;">+</button>

<div id="relatorioContainer" style="display:none; Font-size: 0.65rem; max-height: 800px; overflow-y: auto; background-color: #2b2b2b; color: white; padding: 1rem; border-radius: 0.5rem;">
  <!-- conte√∫do do relat√≥rio -->
  <p>Relat√≥rio carregado aqui</p>
</div>
      </div>
  </div>

<script>

  let eventoEmEdicao = null;

const financeiroData = {
  'Despesas': {
    'Despesas Fixas': ['Aluguel', '√Ågua', 'Internet e Telefone', 'Outros'],
    'Despesas Vari√°veis': ['Compras de Insumos', 'Combust√≠vel'],
    'Marketing e Divulga√ß√£o': ['An√∫ncios Pagos', 'Impress√µes de Cart√µes, Panfletos e Brindes', 'Outros'],
    'Infraestrutura e Equipamentos': ['M√≥veis', 'Acess√≥rios', 'Ferramentas'],
    'Despesas Administrativas': ['Taxas Banc√°rias e Outras'],
    'Despesas Extras ou Opcionais': ['Cursos de atualiza√ß√£o e especializa√ß√£o', 'Uniformes personalizados', 'Caf√©, √°gua, snacks para o atendimento', 'Presentes em datas comemorativas']
  },
  'Ganhos': {
    'C√≠lios': ['Aplica√ß√£o', 'Manuten√ß√£o'],
    'Sobrancelhas': ['Aplica√ß√£o', 'Manuten√ß√£o']
  }
};

const financeiroTipo = document.getElementById('financeiroTipo');
const financeiroFamilia = document.getElementById('financeiroFamilia');
const financeiroNome = document.getElementById('financeiroNome');
const btnAdicionarOcorrencia = document.getElementById("btnAdicionarOcorrencia");
const boxFinanceiro2 = document.getElementById("boxFinanceiro2");
const btnLoadRelatorio = document.getElementById("btnLoadRelatorio");
const relatorioDiv = document.getElementById("relatorioFinanceiro2");
const relatorioContainer = document.getElementById("relatorioContainer");
const resumoDetalhadoDiv = document.getElementById("relatorioResumoDetalhado");

  // Set MesRef to current month when opening the form
  const setMesRefToCurrent = () => {
    const currentMonth = new Date().toISOString().slice(0, 7);
    document.getElementById("financeiroMesRef").value = currentMonth;
  };

  // New event listeners for cascading selects in financeiro2 form
  financeiroTipo.addEventListener("change", () => {
    const tipo = financeiroTipo.value;
    // Clear and disable familia and nome selects initially
    financeiroFamilia.innerHTML = '<option value="" disabled selected>Selecione a Fam√≠lia</option>';
    financeiroNome.innerHTML = '<option value="" disabled selected>Selecione o Nome</option>';
    financeiroFamilia.disabled = true;
    financeiroNome.disabled = true;

    if (tipo && financeiroData[tipo]) {
      // Populate familia options
      Object.keys(financeiroData[tipo]).forEach(familia => {
        const opt = document.createElement("option");
        opt.value = familia;
        opt.textContent = familia;
        financeiroFamilia.appendChild(opt);
      });
      financeiroFamilia.disabled = false;
    }
  });

financeiroFamilia.addEventListener("change", () => {
  const tipo = financeiroTipo.value;
  const familia = financeiroFamilia.value;
  // Clear and disable nome select initially
  financeiroNome.innerHTML = '<option value="" disabled selected>Selecione o Nome</option>';
  financeiroNome.disabled = true;

  if (tipo && familia && financeiroData[tipo] && financeiroData[tipo][familia]) {
    // Populate nome options
    financeiroData[tipo][familia].forEach(nome => {
      const opt = document.createElement("option");
      opt.value = nome;
      opt.textContent = nome;
      financeiroNome.appendChild(opt);
    });
    financeiroNome.disabled = false;
  }
});

// New submit event listener to prevent redirect on form submit and submit asynchronously
const formFinanceiro2 = document.getElementById("formFinanceiro2");
formFinanceiro2.addEventListener("submit", function(event) {
  event.preventDefault(); // Prevent default form submission that causes redirect

  // Gather form data
  const formData = new FormData(formFinanceiro2);

  // Convert to URLSearchParams for x-www-form-urlencoded POST or send as JSON
  // API endpoint expects form post, so send as FormData
  fetch(formFinanceiro2.action, {
    method: formFinanceiro2.method,
    body: formData,
    mode: 'cors'
  }).then(response => {
    if (response.ok) {
      alert("Registrado com sucesso.");
      formFinanceiro2.reset();
      // Optionally hide the form
      boxFinanceiro2.classList.add("hidden");
    } else {
      alert("Erro ao enviar formul√°rio. Tente novamente.");
    }
  }).catch(error => {
    alert("Erro ao enviar formul√°rio. Tente novamente.");
    console.error(error);
  });
});

btnLoadRelatorio.addEventListener("click", () => {
  relatorioContainer.innerHTML = "Carregando...";

  fetch("https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc")
    .then(res => res.json())
    .then(data => {
      if (!data.length) {
        relatorioContainer.innerHTML = "<p>Nenhum dado encontrado.</p>";
        return;
      }

      // Corrige o formato de m√™s
      data.forEach(i => {
        if (i.MesRef) i.MesRef = i.MesRef.slice(0, 7);
      });

      window.financeiroRelatorioData = data;

// Meses √∫nicos
const meses = [...new Set(data.map(d => d.MesRef).filter(Boolean))].sort().reverse();
const mesSelector = document.getElementById("relatorioMesSelector");
mesSelector.innerHTML = "";
meses.forEach(m => {
  const opt = document.createElement("option");
  opt.value = m;
  opt.textContent = m;
  mesSelector.appendChild(opt);
});

// Pega o m√™s atual no formato YYYY-MM
const mesAtualSistema = new Date().toISOString().slice(0, 7);

// Se existir nos meses dispon√≠veis, usa ele; sen√£o, usa o mais recente da lista
const mesInicial = meses.includes(mesAtualSistema) ? mesAtualSistema : (meses[0] || "");

// Define o valor inicial do seletor e atualiza o dashboard
mesSelector.value = mesInicial;
atualizarDashboard(mesInicial);


      relatorioDiv.classList.remove("hidden");
    })
    .catch(err => {
      console.error(err);
      relatorioContainer.innerHTML = "<p>Erro ao carregar dados.</p>";
    });
});

// üîπ Fun√ß√£o para carregar dados do Financeiro automaticamente
async function carregarDadosFinanceiro() {
  const relatorioContainer = document.getElementById("relatorioContainer");
  const toggleBtn = document.getElementById("toggleRelatorioBtn");
  const mesSelector = document.getElementById("relatorioMesSelector");

  // üß© Estado inicial
  if (!relatorioContainer || !toggleBtn) return;
  relatorioContainer.style.display = "none";
  toggleBtn.style.display = "inline-block";
  toggleBtn.textContent = "+";
  toggleBtn.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
  toggleBtn.style.color = "var(--rose)";

  // üéØ Controle do bot√£o "+ / ‚àí"
  toggleBtn.addEventListener("click", () => {
    const expanded = relatorioContainer.style.display !== "none";
    if (expanded) {
      relatorioContainer.style.display = "none";
      toggleBtn.textContent = "+";
      toggleBtn.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
      toggleBtn.style.color = "var(--rose)";
    } else {
      relatorioContainer.style.display = "block";
      toggleBtn.textContent = "‚àí";
      toggleBtn.style.backgroundColor = "rgba(204, 204, 204, 0.3)";
      toggleBtn.style.color = "#111";
    }
  });

  // üîπ Busca dados da planilha
  try {
    const res = await fetch("https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc");
    const data = await res.json();

    if (!data.length) {
      relatorioContainer.innerHTML = "<p class='text-rose-300'>Nenhum dado encontrado.</p>";
      return;
    }

    // Normaliza meses
    data.forEach(i => {
      if (i.MesRef) i.MesRef = i.MesRef.slice(0, 7);
    });

    // Guarda global
    window.financeiroRelatorioData = data;

    // Cria lista de meses √∫nicos
    const meses = [...new Set(data.map(d => d.MesRef).filter(Boolean))].sort().reverse();
    mesSelector.innerHTML = "";
    meses.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      mesSelector.appendChild(opt);
    });

    // Seleciona m√™s atual ou o mais recente
    const mesAtual = new Date().toISOString().slice(0, 7);
    const mesInicial = meses.includes(mesAtual) ? mesAtual : meses[0];
    mesSelector.value = mesInicial;

    // Armazena o m√™s selecionado no localStorage
    localStorage.setItem('mesSelecionadoFinanceiro', mesInicial);

    // Atualiza o dashboard
    atualizarDashboard(mesInicial);

    // Atualiza ao trocar o m√™s
    mesSelector.addEventListener("change", e => {
      atualizarDashboard(e.target.value);
    });

  } catch (err) {
    console.error("Erro ao carregar relat√≥rio:", err);
    relatorioContainer.innerHTML = "<p class='text-red-400'>Erro ao carregar dados da planilha.</p>";
  }

  // üîπ Fun√ß√£o para atualizar o resumo financeiro
  function atualizarDashboard(mesSelecionado) {
    const registros = window.financeiroRelatorioData.filter(item => item.MesRef === mesSelecionado);
    if (!registros.length) {
      dashboardReceita.textContent = "R$0";
      dashboardDespesa.textContent = "R$0";
      dashboardSaldo.textContent = "R$0";
      relatorioContainer.innerHTML = "<p class='text-rose-300'>Nenhum registro para este m√™s.</p>";
      return;
    }

    const ganhos = registros.filter(r => r.Tipo === "Ganhos");
    const despesas = registros.filter(r => r.Tipo === "Despesas");

    const totalGanhos = ganhos.reduce((s, g) => s + parseFloat(g.Valor || 0), 0);
    const totalDespesas = despesas.reduce((s, d) => s + parseFloat(d.Valor || 0), 0);
    const saldo = totalGanhos - totalDespesas;

    dashboardReceita.textContent = `R$${totalGanhos.toFixed(2)}`;
    dashboardDespesa.textContent = `R$${totalDespesas.toFixed(2)}`;
    dashboardSaldo.textContent = `R$${saldo.toFixed(2)}`;

// Mostra o detalhamento dentro da √°rea existente
const relatorioDados = document.getElementById("relatorioDados");

// Se a √°rea n√£o existir, n√£o faz nada (evita duplicar)
if (!relatorioDados) return;

// Limpa apenas o conte√∫do da √°rea de dados
relatorioDados.innerHTML = "";

// Cria os registros mantendo o estilo
registros.forEach(r => {
  const linha = document.createElement("div");
  linha.className = "grid grid-cols-5 gap-2 border-b border-gray-700 py-1 text-xs";
  linha.innerHTML = `
    <div class="text-rose-300 font-semibold">${r.Tipo || "-"}</div>
    <div>${r.Familia || "-"}</div>
    <div>${r.Nome || "-"}</div>
    <div>R$${parseFloat(r.Valor || 0).toFixed(2)}</div>
    <div>${r.Descricao || ""}</div>
  `;
  relatorioDados.appendChild(linha);
});


  }
};

// Carrega dados ao abrir a p√°gina de Financeiro
document.addEventListener("DOMContentLoaded", carregarDadosFinanceiro);

// Listener para mudan√ßa de m√™s (com prote√ß√£o se elemento n√£o existir)
document.addEventListener("DOMContentLoaded", () => {
  const mesSelector = document.getElementById("relatorioMesSelector");
  if (mesSelector) {
    mesSelector.addEventListener("change", (e) => {
      const mes = e.target.value;
      if (window.financeiroRelatorioData) {
        atualizarDashboard(mes);
      }
    });
  }
});

// üîπ Fun√ß√£o para atualizar o resumo financeiro (VERS√ÉO COMPLETA)
function filtrarDadosPorMes(mesSelecionado) {
  return window.financeiroRelatorioData.filter(item => item.MesRef === mesSelecionado);
}

function atualizarDashboard(mesSelecionado) {
  const dadosFiltrados = filtrarDadosPorMes(mesSelecionado);

  const resumoDetalhadoDiv = document.getElementById("relatorioResumoDetalhado");
  const relatorioContainer = document.getElementById("relatorioContainer");

  if (!dadosFiltrados.length) {
    // Caso n√£o tenha dados, mostra mensagem no resumo e oculta tabela
    if (resumoDetalhadoDiv) resumoDetalhadoDiv.innerHTML = "<p>Sem dados para este m√™s :(</p>";
    if (relatorioContainer) relatorioContainer.innerHTML = "";
    if (resumoDetalhadoDiv) resumoDetalhadoDiv.style.display = "block";
    if (relatorioContainer) relatorioContainer.style.display = "none";
    
    // Zera o painel
    renderizarPainel({ receita: 0, despesa: 0, saldo: 0 });
    return;
  }

  // Garante que o resumo √© vis√≠vel e a tabela detalhada, n√£o.
  if (resumoDetalhadoDiv) resumoDetalhadoDiv.style.display = "block";
  if (relatorioContainer) relatorioContainer.style.display = "none";

  const totais = calcularTotais(dadosFiltrados);
  const dadosAgrupados = agruparDados(dadosFiltrados);

  renderizarPainel(totais);
  renderizarResumoDetalhado(dadosAgrupados);
  renderizarTabelaRelatorio(dadosFiltrados);
}


function parseValorBR(str) {
  if (!str) return 0;
  str = str.toString().trim();
  if (str.includes(',')) {
    str = str.replace(/\./g, '');
    str = str.replace(',', '.');
  }
  return parseFloat(str) || 0;
}

function calcularTotais(dados) {
  // Aggregate sums grouped by Tipo
  let receita = 0;
  let despesa = 0;
  dados.forEach(item => {
    const tipo = item["Tipo"];
    const valor = parseValorBR(item["Valor"]);
    if (tipo === "Ganhos") receita += valor;
    else if (tipo === "Despesas") despesa += valor;
  });
  return { receita, despesa, saldo: receita - despesa };
}

function renderizarPainel(totais) {
  // Format values to BRL currency
  const formataValor = v => "R$" + v.toFixed(2).replace(".", ",");

  document.getElementById("dashboardReceita").textContent = formataValor(totais.receita);
  document.getElementById("dashboardDespesa").textContent = formataValor(totais.despesa);
  document.getElementById("dashboardSaldo").textContent = formataValor(totais.saldo);

  // Replicate data to home resumo (apenas se existir na p√°gina)
  const elReceita = document.querySelector("#resumoReceita p");
  const elDespesa = document.querySelector("#resumoDespesa p");
  const elSaldo = document.querySelector("#resumoSaldo p");
  
  if (elReceita) elReceita.textContent = formataValor(totais.receita);
  if (elDespesa) elDespesa.textContent = formataValor(totais.despesa);
  if (elSaldo) elSaldo.textContent = formataValor(totais.saldo);
}

function agruparDados(dados) {
  // Helper to safely accumulate sums
  const acumulador = {};

  dados.forEach(item => {
    const tipo = item["Tipo"] || "Sem Tipo";
    const familia = item["Familia"] || "Sem Fam√≠lia";
    const nome = item["Nome"] || "Sem Nome";
    const valor = parseFloat(item["Valor"]) || 0;

    if (!acumulador[tipo]) acumulador[tipo] = { total: 0, familias: {} };
    acumulador[tipo].total += valor;

    if (!acumulador[tipo].familias[familia]) acumulador[tipo].familias[familia] = { total: 0, nomes: {} };
    acumulador[tipo].familias[familia].total += valor;

    if (!acumulador[tipo].familias[familia].nomes[nome]) acumulador[tipo].familias[familia].nomes[nome] = 0;
    acumulador[tipo].familias[familia].nomes[nome] += valor;
  });
  return acumulador;
}

function renderizarResumoDetalhado(dadosAgrupados) {
  // Helper to create a row with category left and value right with dotted leader
  function createRow(label, value, options = {}) {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.marginBottom = options.marginBottom || "2px";

    // Label container flex
    const labelContainer = document.createElement("div");
    labelContainer.style.display = "flex";
    labelContainer.style.alignItems = "center";
    labelContainer.style.flexGrow = "1";

    const labelSpan = document.createElement("span");
    labelSpan.textContent = label;
    labelSpan.style.fontWeight = options.bold ? "bold" : "normal";
    labelSpan.style.fontStyle = options.italic ? "italic" : "normal";
    labelSpan.style.fontSize = options.fontSize || "1rem";
    labelSpan.style.paddingLeft = options.paddingLeft || "0";
    labelSpan.style.whiteSpace = "nowrap";
    labelSpan.style.zIndex = "1";

    // Dots filler that expands horizontally between label and value
    const dotsSpan = document.createElement("span");
    dotsSpan.style.flexGrow = "1";
    dotsSpan.style.borderBottom = "1px dotted #cccccc";
    dotsSpan.style.margin = "0 6px";

    // Value container fixed width on right
    const valueSpan = document.createElement("span");
    valueSpan.textContent = value;
    valueSpan.style.fontWeight = options.bold ? "bold" : "normal";
    valueSpan.style.whiteSpace = "nowrap";
    valueSpan.style.minWidth = "7ch";
    valueSpan.style.textAlign = "right";

    labelContainer.appendChild(labelSpan);
    labelContainer.appendChild(dotsSpan);

    row.appendChild(labelContainer);
    row.appendChild(valueSpan);

    return row;
  }

  const formataValor = v => "R$" + v.toFixed(2).replace(".", ",");
  const resumoDetalhadoDiv = document.getElementById("relatorioResumoDetalhado");
  resumoDetalhadoDiv.innerHTML = ""; // Limpa conte√∫do

  // Iterate over Tipo groups, then Familias, then Nomes, adding subtotal and total lines with separators
  let grandTotal = 0;
  for (const tipoKey in dadosAgrupados) {
    const tipoTotal = formataValor(dadosAgrupados[tipoKey].total);
    // Add a separator line for Tipo groups except first
    if (resumoDetalhadoDiv.childElementCount > 0) {
      const hr = document.createElement("hr");
      hr.style.border = "none";
      hr.style.borderTop = "1px solid #cccccc";
      hr.style.margin = "10px 0";
      resumoDetalhadoDiv.appendChild(hr);
    }
    resumoDetalhadoDiv.appendChild(createRow(tipoKey.toUpperCase(), tipoTotal, { bold: true, marginBottom: "6px" }));

    const familias = dadosAgrupados[tipoKey].familias;
    for (const famKey in familias) {
      const famTotal = formataValor(familias[famKey].total);
      resumoDetalhadoDiv.appendChild(createRow("‚îî " + famKey, famTotal, { fontSize: "0.875rem", paddingLeft: "1rem", marginBottom: "4px" , italic: false}));

      const nomes = familias[famKey].nomes;
      for (const nomeKey in nomes) {
        const nomeTotal = formataValor(nomes[nomeKey]);
      resumoDetalhadoDiv.appendChild(createRow("   ‚îî " + nomeKey, nomeTotal, { fontSize: "0.875rem", paddingLeft: "2rem", marginBottom: "2px", italic: false }));
      }

      // Add Familia subtotal separator line with background
      const famSubtotalContainer = document.createElement("div");
      famSubtotalContainer.style.backgroundColor = "rgba(204, 204, 204, 0.1)";
      famSubtotalContainer.style.padding = "2px 6px";
      famSubtotalContainer.style.marginBottom = "10px";
      famSubtotalContainer.style.borderRadius = "4px";
      
      const famSubtotalHr = document.createElement("hr");
      famSubtotalHr.style.border = "none";
      famSubtotalHr.style.borderTop = "1px dotted #cccccc";
      famSubtotalHr.style.margin = "0 0 0 1rem";
      famSubtotalContainer.appendChild(famSubtotalHr);

      resumoDetalhadoDiv.appendChild(famSubtotalContainer);
    }

    grandTotal += dadosAgrupados[tipoKey].total;
  }

  // Add grand total line after all Tipos with background
  const grandTotalContainer = document.createElement("div");
  grandTotalContainer.style.backgroundColor = "rgba(204, 204, 204, 0.2)";
  grandTotalContainer.style.borderRadius = "6px";
  grandTotalContainer.style.padding = "6px 10px";
  grandTotalContainer.style.margin = "12px 0";

  grandTotalContainer.appendChild(createRow("TOTAL", formataValor(grandTotal), { bold: true, marginBottom: "0" }));

  resumoDetalhadoDiv.appendChild(grandTotalContainer);
}

function renderizarTabelaRelatorio(dadosFiltrados) {
  const formataValor = v => "R$" + v.toFixed(2).replace(".", ",");
  relatorioContainer.innerHTML = ""; // clear existing table
  if (!dadosFiltrados.length) return;

  const table = document.createElement("table");
  table.className = "w-full text-left border-collapse";
  table.style.border = "none"; // Remove outer border

  const thead = document.createElement("thead");
  const headerRow = document.createElement("tr");
  // Reduced header cell padding for tighter rows
  const headerCellPadding = "4px 6px";
  

  const keys = Object.keys(dadosFiltrados[0]);
  keys.forEach(key => {
  const th = document.createElement("th");

  // üîπ Renomeia apenas DtRegistro ‚Üí Data
  if (key === "DtRegistro") {
    th.textContent = "Data";
  } else {
    th.textContent = key;
  }

  // üî∏ Centraliza o texto do cabe√ßalho
  th.style.textAlign = "center";

  headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  const cellPadding = "4px 6px";

  // üîπ Dentro do loop que cria as linhas da tabela (tr)
  dadosFiltrados.forEach((row, index) => {
  const tr = document.createElement("tr");
  tr.className = "registro";
  tr.dataset.index = index;

  // üîπ Efeito zebrado: alterna cores entre linhas
  tr.style.backgroundColor = index % 2 === 0 ? "#2d2d2d" : "#3a3a3a"; // contraste mais forte
  tr.style.transition = "background-color 0.3s ease";

  keys.forEach(key => {
    const td = document.createElement("td");
    let valor = row[key];

    // üî∏ Formata DtRegistro ‚Üí DD/MM (sem ano)
    if (key === "DtRegistro" && valor) {
      const [ano, mes, dia] = valor.split("-");
      valor = `${dia}/${mes}`;
    }

    // üî∏ Formata MesRef ‚Üí MM/AA
    if (key === "MesRef" && valor) {
      const [ano, mes] = valor.split("-");
      valor = `${mes}/${ano.slice(2)}`;
    }

    td.textContent = valor || "‚Äî";
    td.style.textAlign = "center";
    td.style.padding = "4px 6px";
    tr.appendChild(td);
  });

  // üîπ Bot√£o de exclus√£o (mant√©m o que j√° tem)
  const tdAcoes = document.createElement("td");
  tdAcoes.style.textAlign = "center";

  const btnExcluir = document.createElement("button");
  btnExcluir.textContent = "üóëÔ∏è";
  btnExcluir.title = "Excluir Registro";
  btnExcluir.style.color = "#ff7373";
  btnExcluir.style.cursor = "pointer";

  btnExcluir.addEventListener("click", async () => {
    if (!confirm("Deseja realmente excluir este registro?")) return;

    try {
      const baseURL = "https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc";
      const res = await fetch(`${baseURL}?nocache=${Date.now()}`);
      const dados = await res.json();

      const normaliza = str => (str || "").trim().toLowerCase();

      const match = dados.find(d =>
        normaliza(d.DtRegistro) === normaliza(row.DtRegistro) &&
        normaliza(d.Descricao) === normaliza(row.Descricao) &&
        normaliza(d.MesRef) === normaliza(row.MesRef) &&
        parseFloat(d.Valor || 0) === parseFloat(row.Valor || 0)
      );

      if (!match) {
        alert("‚ùå Registro n√£o encontrado na planilha.");
        return;
      }

      const deleteURL = `${baseURL}/DtRegistro/${encodeURIComponent(match.DtRegistro)}`;
      const del = await fetch(deleteURL, { method: "DELETE" });

      if (del.ok) {
  // Efeito visual de exclus√£o
  tr.style.transition = "opacity 0.4s ease";
  tr.style.opacity = "0";
  setTimeout(() => tr.remove(), 400);

  alert("‚úÖ Registro exclu√≠do com sucesso!");

  // üîπ Atualiza a vari√°vel global removendo o registro localmente
  if (window.financeiroRelatorioData) {
    window.financeiroRelatorioData = window.financeiroRelatorioData.filter(item =>
      !(
        item.DtRegistro === row.DtRegistro &&
        item.Descricao === row.Descricao &&
        item.MesRef === row.MesRef &&
        parseFloat(item.Valor || 0) === parseFloat(row.Valor || 0)
      )
    );
  }

  // üîπ Atualiza o dashboard imediatamente com o m√™s atual
  const mesAtual = document.getElementById("relatorioMesSelector")?.value;
  if (typeof atualizarDashboard === "function" && mesAtual) {
    atualizarDashboard(mesAtual);
  }
  } else {
  alert("‚ùå Erro ao excluir da planilha.");
  }


    } catch (err) {
      console.error("Erro ao excluir registro:", err);
      alert("‚ùå Erro ao excluir registro. Verifique a conex√£o e tente novamente.");
    }
  });

  tdAcoes.appendChild(btnExcluir);
  tr.appendChild(tdAcoes);
  tbody.appendChild(tr);
  });

table.appendChild(tbody);
    relatorioContainer.appendChild(table);
}

function renderizarResumoDetalhadoHome(dadosAgrupados) {
  const homeResumoDetalhadoDiv = document.getElementById("homeResumoDetalhado");
  
  // Se o elemento n√£o existir na p√°gina (como em p√°ginas que n√£o s√£o Home), n√£o faz nada
  if (!homeResumoDetalhadoDiv) return;
  
  const formataValor = v => "R$" + v.toFixed(2).replace(".", ",");
  homeResumoDetalhadoDiv.innerHTML = ""; // Limpa conte√∫do

  // Helper to create a row with category left and value right with dotted leader
  function createRow(label, value, options = {}) {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.marginBottom = options.marginBottom || "2px";

    // Label container flex
    const labelContainer = document.createElement("div");
    labelContainer.style.display = "flex";
    labelContainer.style.alignItems = "center";
    labelContainer.style.flexGrow = "1";

    const labelSpan = document.createElement("span");
    labelSpan.textContent = label;
    labelSpan.style.fontWeight = options.bold ? "bold" : "normal";
    labelSpan.style.fontStyle = options.italic ? "italic" : "normal";
    labelSpan.style.fontSize = options.fontSize || "1rem";
    labelSpan.style.paddingLeft = options.paddingLeft || "0";
    labelSpan.style.whiteSpace = "nowrap";
    labelSpan.style.zIndex = "1";

    // Dots filler that expands horizontally between label and value
    const dotsSpan = document.createElement("span");
    dotsSpan.style.flexGrow = "1";
    dotsSpan.style.borderBottom = "1px dotted #cccccc";
    dotsSpan.style.margin = "0 6px";

    // Value container fixed width on right
    const valueSpan = document.createElement("span");
    valueSpan.textContent = value;
    valueSpan.style.fontWeight = options.bold ? "bold" : "normal";
    valueSpan.style.whiteSpace = "nowrap";
    valueSpan.style.minWidth = "7ch";
    valueSpan.style.textAlign = "right";

    labelContainer.appendChild(labelSpan);
    labelContainer.appendChild(dotsSpan);

    row.appendChild(labelContainer);
    row.appendChild(valueSpan);

    return row;
  }

  // Iterate over Tipo groups, then Familias, then Nomes, adding subtotal and total lines with separators
  let grandTotal = 0;
  for (const tipoKey in dadosAgrupados) {
    const tipoTotal = formataValor(dadosAgrupados[tipoKey].total);
    // Add a separator line for Tipo groups except first
    if (homeResumoDetalhadoDiv.childElementCount > 0) {
      const hr = document.createElement("hr");
      hr.style.border = "none";
      hr.style.borderTop = "1px solid #cccccc";
      hr.style.margin = "10px 0";
      homeResumoDetalhadoDiv.appendChild(hr);
    }
    homeResumoDetalhadoDiv.appendChild(createRow(tipoKey.toUpperCase(), tipoTotal, { bold: true, marginBottom: "6px" }));

    const familias = dadosAgrupados[tipoKey].familias;
    for (const famKey in familias) {
      const famTotal = formataValor(familias[famKey].total);
      homeResumoDetalhadoDiv.appendChild(createRow("‚îî " + famKey, famTotal, { fontSize: "0.875rem", paddingLeft: "1rem", marginBottom: "4px" , italic: false}));

      const nomes = familias[famKey].nomes;
      for (const nomeKey in nomes) {
        const nomeTotal = formataValor(nomes[nomeKey]);
      homeResumoDetalhadoDiv.appendChild(createRow("   ‚îî " + nomeKey, nomeTotal, { fontSize: "0.875rem", paddingLeft: "2rem", marginBottom: "2px", italic: false }));
      }

      // Add Familia subtotal separator line with background
      const famSubtotalContainer = document.createElement("div");
      famSubtotalContainer.style.backgroundColor = "rgba(204, 204, 204, 0.1)";
      famSubtotalContainer.style.padding = "2px 6px";
      famSubtotalContainer.style.marginBottom = "10px";
      famSubtotalContainer.style.borderRadius = "4px";

      const famSubtotalHr = document.createElement("hr");
      famSubtotalHr.style.border = "none";
      famSubtotalHr.style.borderTop = "1px dotted #cccccc";
      famSubtotalHr.style.margin = "0 0 0 1rem";
      famSubtotalContainer.appendChild(famSubtotalHr);

      homeResumoDetalhadoDiv.appendChild(famSubtotalContainer);
    }

    grandTotal += dadosAgrupados[tipoKey].total;
  }

  // Add grand total line after all Tipos with background
  const grandTotalContainer = document.createElement("div");
  grandTotalContainer.style.backgroundColor = "rgba(204, 204, 204, 0.2)";
  grandTotalContainer.style.borderRadius = "6px";
  grandTotalContainer.style.padding = "6px 10px";
  grandTotalContainer.style.margin = "12px 0";

  grandTotalContainer.appendChild(createRow("TOTAL", formataValor(grandTotal), { bold: true, marginBottom: "0" }));

  homeResumoDetalhadoDiv.appendChild(grandTotalContainer);
}

async function atualizarResumoFinanceiroHome() {
  try {
    const res = await fetch("https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc");
    const data = await res.json();

    // Corrige formato dos meses (yyyy-MM)
    data.forEach(i => {
      if (i.MesRef) i.MesRef = i.MesRef.slice(0, 7);
    });

    const mesAtual = new Date().toISOString().slice(0, 7);
    const filtrados = data.filter(i => i.MesRef === mesAtual);

    // üîπ Elementos do DOM (podem N√ÉO existir em outras p√°ginas)
    const elResumoDetalhado = document.getElementById("homeResumoDetalhado");
    const elReceita = document.querySelector("#resumoReceita p");
    const elDespesa = document.querySelector("#resumoDespesa p");
    const elSaldo   = document.querySelector("#resumoSaldo p");

    // üîπ Se n√£o houver dados do m√™s
    if (!filtrados.length) {
      if (elResumoDetalhado) {
        elResumoDetalhado.innerHTML = "<p>Sem dados para este m√™s :(</p>";
      }

      if (elReceita) elReceita.textContent = "R$ 0,00";
      if (elDespesa) elDespesa.textContent = "R$ 0,00";
      if (elSaldo)   elSaldo.textContent   = "R$ 0,00";

      return;
    }

    let receita = 0;
    let despesa = 0;

    filtrados.forEach(i => {
      const valor = parseFloat(i.Valor) || 0;
      if (i.Tipo === "Ganhos") {
        receita += valor;
      } else if (i.Tipo === "Despesas") {
        despesa += valor;
      }
    });

    const formataValor = v => "R$" + v.toFixed(2).replace(".", ",");

    // üîπ Atualiza os cards (somente se existirem)
    if (elReceita) elReceita.textContent = formataValor(receita);
    if (elDespesa) elDespesa.textContent = formataValor(despesa);
    if (elSaldo)   elSaldo.textContent   = formataValor(receita - despesa);

    // üîπ Resumo detalhado (somente na Home)
    if (elResumoDetalhado) {
      const dadosAgrupados = agruparDados(filtrados);
      renderizarResumoDetalhadoHome(dadosAgrupados);
    }

  } catch (err) {
    console.error("Erro ao atualizar resumo financeiro:", err);
  }
}



document.addEventListener("DOMContentLoaded", atualizarResumoFinanceiroHome);
const SHEET_FINANCEIRO_URL = "https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc/tabs/Financeiro";
const SHEET_CADASTROS_URL = "https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc/tabs/Cadastros";

let clientesData = [];

async function carregarClientesAtivos() {
  const select = document.getElementById("agendamentoCliente");
  if (!select) return;

  try {
    const res = await fetch(SHEET_CADASTROS_URL);
    const data = await res.json();

    // Filtra apenas clientes ativos
    clientesData = data.filter(c => c.Status && c.Status.toLowerCase() === "ativo");

    // Limpa op√ß√µes antigas
    select.innerHTML = '<option value="">Selecione um cliente</option>';

    clientesData.forEach(c => {
      const option = document.createElement("option");
      option.value = c.Nome;
      option.textContent = c.Nome;
      select.appendChild(option);
    });
  } catch (err) {
    console.error("Erro ao carregar clientes ativos:", err);
  }
}

// Preenche o CEP automaticamente ao selecionar o cliente
document.getElementById("agendamentoCliente").addEventListener("change", function() {
  const cepInput = document.getElementById("agendamentoCep");
  const clienteSelecionado = clientesData.find(c => c.Nome === this.value);
  cepInput.value = clienteSelecionado ? clienteSelecionado.CEP : "";
});

// Inicializa ao carregar a p√°gina
carregarClientesAtivos();


const SHEET_CLIENTES_URL = "https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc/tabs/Cadastros";

// ‚úÖ Salvar cliente na planilha SheetBest
async function salvarClienteSheet(cliente) {
  try {
    const response = await fetch(SHEET_CLIENTES_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(cliente),
    });
    if (!response.ok) throw new Error("Erro ao salvar cliente.");
    alert("‚úÖ Cliente registrado com sucesso!");
    carregarClientes();
  } catch (error) {
    console.error("Erro ao registrar cliente:", error);
    alert("‚ùå Erro ao registrar cliente na planilha.");
  }
}

async function excluirClientePlanilha(nome) {
  if (!nome) return alert("Nome inv√°lido.");
  if (!confirm(`Tem certeza que deseja excluir "${nome}" da planilha?`)) return;

  const baseURL = "https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc/tabs/Cadastros";

  try {
    // Normaliza texto
    const normaliza = (str) =>
      (str || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim()
        .toLowerCase();

    // Busca inicial sem cache
    const res = await fetch(`${baseURL}?nocache=${Date.now()}`, { cache: "no-store" });
    const data = await res.json();

    const cliente = data.find((c) => normaliza(c.Nome) === normaliza(nome));
    if (!cliente) {
      alert(`‚ùå Cliente "${nome}" n√£o encontrado.`);
      return;
    }

    // Remove visualmente da tela
    const cards = document.querySelectorAll("#listaClientes > div");
    cards.forEach(card => {
      if (card.innerText.toLowerCase().includes(nome.toLowerCase())) {
        card.style.transition = "opacity 0.4s ease";
        card.style.opacity = "0";
        setTimeout(() => card.remove(), 400);
      }
    });

    // Exclui na planilha
    const deleteURL = `${baseURL}/Nome/${encodeURIComponent(cliente.Nome)}`;
    const delRes = await fetch(deleteURL, { method: "DELETE" });
    if (!delRes.ok) throw new Error("Falha ao excluir.");

    alert(`‚úÖ Cliente "${nome}" exclu√≠do.`);

  } catch (err) {
    console.error("Erro ao excluir cliente:", err);
    alert("‚ùå Erro ao excluir cliente. Verifique a conex√£o e tente novamente.");
  }
}

async function editarCliente(nome) {
  try {
    const res = await fetch(SHEET_CLIENTES_URL);
    const data = await res.json();

    const cliente = data.find(c => c.Nome?.trim().toLowerCase() === nome.trim().toLowerCase());
    if (!cliente) return alert("Cliente n√£o encontrado.");

    // Preenche os campos
    document.getElementById("clienteNome").value = cliente.Nome || "";
    document.getElementById("clienteCpf").value = cliente.CPF || "";
    document.getElementById("clienteTelefone").value = cliente.Telefone || "";
    document.getElementById("clienteDn").value = cliente.DN || "";
    document.getElementById("clienteEnderecoNum").value = cliente.Endereco || "";
    document.getElementById("clienteCep").value = cliente.CEP || "";
    document.getElementById("clienteInstagram").value = cliente.Instagram || "";
    document.getElementById("clienteStatus").value = cliente.Status || "Ativo";

    // Mostra o modal com a anima√ß√£o correta
    const box = document.getElementById("boxCliente");
    const content = document.getElementById("boxClienteContent");

    document.getElementById("tituloCliente").textContent = "Editar Cliente";

    box.classList.remove("hidden");
    // ‚ö° Anima suavemente como no bot√£o "Adicionar Cliente"
    setTimeout(() => {
      content.classList.remove("scale-95", "opacity-0");
      content.classList.add("scale-100", "opacity-100");
    }, 10);

    // Guarda o nome do cliente em edi√ß√£o
    window.clienteEditando = cliente.Nome;

  } catch (err) {
    console.error("Erro ao editar cliente:", err);
    alert("Erro ao carregar dados para edi√ß√£o.");
  }
}

// --- üîπ Fun√ß√£o para formatar data e calcular idade ---
function formatarDataEIdade(dataStr, apenasData = false) {
  if (!dataStr) return "";
  const data = new Date(dataStr);
  if (isNaN(data)) return dataStr;

  const dia = String(data.getDate()).padStart(2, "0");
  const mes = String(data.getMonth() + 1).padStart(2, "0");
  const ano = String(data.getFullYear()).slice(-2);

  if (apenasData) return `${dia}/${mes}/${ano}`;

  const hoje = new Date();
  let idade = hoje.getFullYear() - data.getFullYear();
  const m = hoje.getMonth() - data.getMonth();
  if (m < 0 || (m === 0 && hoje.getDate() < data.getDate())) idade--;

  return `${idade} anos`;
}

// üîπ Fun√ß√£o auxiliar para criar o card de um cliente
function criarCardCliente(cli) {
  const isAtivo = (cli.status || "").toLowerCase() === "ativo";
  const corStatus = isAtivo ? "bg-green-200 text-green-900" : "bg-red-400 text-[#1e1e1e]";
  const idTipo = `tipo-${cli.nome.replace(/\s+/g, "-")}`;
  const idData = `data-${cli.nome.replace(/\s+/g, "-")}`;

  const card = document.createElement("div");
  card.className = "cliente-card flex items-center text-[#f5c5b5] rounded-2xl p-4 w-full max-w-5xl mx-auto mb-4";
  card.innerHTML = `
    <div class="w-12 h-12 flex items-center justify-center rounded-full mr-4 shadow-md"
         style="background: linear-gradient(135deg, #b88c7a, #f4bfae); color: white; font-weight: 700; font-size: 1.50rem;">
      ${cli.nome.charAt(0).toUpperCase()}
    </div>
    <div class="flex flex-col justify-center flex-1 border border-transparent rounded-md p-0.5">
        <div class="flex items-center gap-2 mb-1">
            <h2 class="font-semibold text-xl">${cli.nome}</h2>
            <span class="${corStatus} text-xs font-semibold px-2 py-0.5 rounded-md">${cli.status}</span>
        </div>
        <div class="grid grid-cols-2 gap-x-6 items-center">
            <div class="flex flex-col justify-center text-xs text-left">
                <p class="italic">@${cli.instagram || "instagram"}</p>
                <p><i class="fas fa-phone mr-1"></i>${cli.telefone || "-"}</p>
                <p>${cli.endereco || ""}</p>
                <p>${cli.cep}</p>
            </div>
            <div class="flex flex-col justify-center text-xs italic text-right">
                <p>${formatarDataEIdade(cli.dn)}</p>
                <p>${formatarDataEIdade(cli.dn, true)}</p>
            </div>
        </div>
    </div>
    <div class="flex flex-col items-center rounded-md p-2 ml-4 shadow-inner" 
         style="width:150px; background-color:rgba(50,50,50,0.08); backdrop-filter:blur(2px); border:1px solid rgba(89,89,89,0.15); background-color:#2b2b2b; background-image: radial-gradient(#3a3a3a 1px, transparent 1px); background-size:6px 6px; border:1px solid #3a3a3a;">
        <div class="font-semibold text-xs rounded-md px-3 py-1 mb-1 shadow-sm whitespace-nowrap w-full text-center" style="color:#f5c5b5;">
            Agendamentos
        </div>
        <div class="border-2 rounded-md px-3 py-2 text-center text-xs whitespace-nowrap w-full shadow-sm" style="border-color:#3a3a3a; background-color:#2b2b2b; background-size:6px 6px;">
            <p id="${idTipo}" class="font-semibold text-[#f5c5b5]">Carregando...</p>
            <p id="${idData}" class="text-[#f5c5b5]">--/--/----</p>
        </div>
    </div>
    <div class="flex flex-col justify-center items-center gap-2 ml-4">
        <button class="text- hover:text-green-300" onclick="window.open('https://wa.me/55${(cli.telefone || '').replace(/\D/g,'')}', '_blank')">
            <i class="fab fa-whatsapp text-lg"></i>
        </button>
        <button class="text- hover:text-yellow-800" onclick="editarCliente('${cli.nome}')">
            <i class="fas fa-edit text-lg"></i>
        </button>
        <button class="text- hover:text-red-400" onclick="excluirClientePlanilha('${cli.nome}')">
            <i class="fas fa-trash text-lg"></i>
        </button>
    </div>`;

  return card;
}

// ‚úÖ Carregar clientes
async function carregarClientes() {
  const container = document.getElementById("listaClientes");
  container.innerHTML = "<p class='text-center text-rose-300'>Carregando...</p>";

  try {
    const [resClientes, resCadastros] = await Promise.all([
      fetch(SHEET_CLIENTES_URL),
      fetch(`${SHEET_CLIENTES_URL}?nocache=${Date.now()}`) // Usado para agendamentos
    ]);

    const data = await resClientes.json();
    const cadastrosData = await resCadastros.json();

    if (!data.length) {
      container.innerHTML = "<p class='text-center text-rose-300'>Nenhum cliente cadastrado.</p>";
      return;
    }

    const filtro = document.querySelector('input[name="filtroStatus"]:checked')?.value || "todos";

    const clientes = data
      .filter((c) => c.Nome && c.Nome.trim() !== "")
      .map((c) => ({
        nome: c.Nome,
        cpf: c.CPF,
        telefone: c.Telefone,
        dn: c.DN,
        endereco: c.Endereco,
        cep: c.CEP,
        instagram: c.Instagram,
        status: (c.Status || "").toLowerCase(),
      }))
      .filter((c) => filtro === "todos" || c.status === filtro.toLowerCase());

    if (!clientes.length) {
      container.innerHTML = "<p class='text-center text-rose-300'>Nenhum cliente com este status.</p>";
      return;
    }

    container.innerHTML = "";

    clientes.forEach((cli) => {
      const card = criarCardCliente(cli);
      container.appendChild(card);

      const normaliza = (txt) => (txt || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toLowerCase();

async function buscarAgendamento(cli) {
  try {
    const response = await fetch('https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc/tabs/Agenda');
    const data = await response.json();

    const agora = new Date();

    const futuros = data
      .map(item => {
        if (!item.Cliente || !item.Data || !item.Hora) return null;

        const nomeApi = normaliza(item.Cliente);
        const dataHora = new Date(`${item.Data}T${item.Hora}:00`);

        if (isNaN(dataHora)) return null;

        return { item, nomeApi, dataHora };
      })
      .filter(x => x && x.nomeApi === normaliza(cli.nome) && x.dataHora >= agora)
      .sort((a, b) => a.dataHora - b.dataHora);

    const proximo = futuros[0];

    const idTipo = `tipo-${cli.nome.replace(/\s+/g, "-")}`;
    const idData = `data-${cli.nome.replace(/\s+/g, "-")}`;
    const tipoEl = card.querySelector(`#${idTipo}`);
    const dataEl = card.querySelector(`#${idData}`);

    if (proximo) {
      // Formata DD/MM √†s HH:MM
      const dt = proximo.dataHora;
      const dia = String(dt.getDate()).padStart(2, '0');
      const mes = String(dt.getMonth() + 1).padStart(2, '0');
      const horas = String(dt.getHours()).padStart(2, '0');
      const minutos = String(dt.getMinutes()).padStart(2, '0');
      const dataFormatada = `${dia}/${mes} √†s ${horas}:${minutos}`;
      dataEl.textContent = dataFormatada;

      // Tipo do atendimento agora usa a coluna "Procedimento"
      const procedimentoRaw = proximo.item.Procedimento || "Aplica√ß√£o";
      let tipo = "APL";
      if (normaliza(procedimentoRaw) === "manutencao") {
        tipo = "MAN";
      }

      // Modalidade
      let modalidade = proximo.item.Modalidade || "Extens√£o";
      if (normaliza(modalidade) === "extensao de cilios") {
        modalidade = "Extens√£o";
      }

      tipoEl.textContent = `${tipo} ${modalidade}`; // Ex: MAN Extens√£o

      tipoEl.style.color = "#f5c5b5";
      dataEl.style.color = "#f5c5b5";
    } else {
      tipoEl.textContent = "Sem Agendamento";
      dataEl.textContent = "‚ö†Ô∏è";
      tipoEl.style.color = "#ffd966";
      dataEl.style.color = "#ffd966";
    }

  } catch (error) {
    console.error("Erro ao buscar agendamento:", error);
  }
}

// Exemplo de uso
buscarAgendamento(cli);

    });

  } catch (err) {
    console.error("Erro ao carregar clientes:", err);
    container.innerHTML = "<p class='text-center text-red-400'>Erro ao carregar dados.</p>";
  }
}

// ‚úÖ Enviar cliente (substitui localStorage)
document.getElementById("formCliente").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const cliente = Object.fromEntries(formData.entries());

  // Se for edi√ß√£o
  if (window.clienteEditando) {
    try {
      const url = `${SHEET_CLIENTES_URL}/Nome/${encodeURIComponent(window.clienteEditando)}`;
      const response = await fetch(url, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(cliente),
      });
      if (!response.ok) throw new Error("Erro ao atualizar cliente.");
      alert("‚úÖ Cliente atualizado com sucesso!");
      delete window.clienteEditando;
      carregarClientes();
    } catch (err) {
      console.error("Erro ao atualizar cliente:", err);
      alert("‚ùå Erro ao salvar altera√ß√µes.");
    }
  } else {
    // Novo cadastro
    salvarClienteSheet(cliente);
  }

  e.target.reset();
  document.getElementById("boxCliente").classList.add("hidden");
});


// Atualiza automaticamente quando o filtro muda
document.querySelectorAll('input[name="filtroStatus"]').forEach(radio => {
  radio.addEventListener("change", carregarClientes);
});


document.addEventListener("DOMContentLoaded", function() {
  // Add toggle for Ocorr√™ncia form similar to Anamnese and Clientes
  const btnAdicionarOcorrencia = document.getElementById("btnAdicionarOcorrencia");
  const boxFinanceiro2 = document.getElementById("boxFinanceiro2");
  btnAdicionarOcorrencia.addEventListener("click", function(e) {
    e.stopPropagation();
    boxFinanceiro2.classList.toggle("hidden");
  });
  document.addEventListener("click", function(e) {
    if (!boxFinanceiro2.classList.contains("hidden")) {
      const isClickInside = boxFinanceiro2.contains(e.target) || btnAdicionarOcorrencia.contains(e.target);
      if (!isClickInside) boxFinanceiro2.classList.add("hidden");
    }
  });
  document.getElementById("fecharBoxFinanceiro2").addEventListener("click", function() {
    boxFinanceiro2.classList.add("hidden");
  });
    // L√≥gica para mostrar/esconder o formul√°rio de cliente
    const btnAdicionarCliente = document.getElementById("btnAdicionarCliente");
    const boxCliente = document.getElementById("boxCliente");
    btnAdicionarCliente.addEventListener("click", function(e) {
  e.stopPropagation();
  editingIndex = -1;
  document.getElementById("formCliente").reset();
  document.getElementById("tituloCliente").textContent = "Cadastro de Cliente";

  const box = document.getElementById("boxCliente");
  const content = document.getElementById("boxClienteContent");

  // Exibe modal
  box.classList.remove("hidden");
  setTimeout(() => {
    content.classList.remove("scale-95", "opacity-0");
    content.classList.add("scale-100", "opacity-100");
  }, 10);
});

    document.addEventListener("click", function(e) {
      if (!boxCliente.classList.contains("hidden")) {
        const isClickInside = boxCliente.contains(e.target) || btnAdicionarCliente.contains(e.target);
        if (!isClickInside) boxCliente.classList.add("hidden");
      }
    });
    document.getElementById("fecharBoxCliente").addEventListener("click", function() {
  const box = document.getElementById("boxCliente");
  const content = document.getElementById("boxClienteContent");

  // Anima para fechar
  content.classList.remove("scale-100", "opacity-100");
  content.classList.add("scale-95", "opacity-0");

  setTimeout(() => {
    box.classList.add("hidden");
  }, 250);
});


  const sidebar = document.getElementById("sidebar");
  const menuBtn = document.getElementById("menuBtn");
  menuBtn.addEventListener("click", function(e) {
    sidebar.classList.toggle("sidebar-hidden");
    e.stopPropagation();
  });

  // Fecha o menu ao clicar fora da sidebar ou do bot√£o
  document.addEventListener("click", function(e) {
    if (!sidebar.classList.contains("sidebar-hidden")) {
      const isClickInsideSidebar = sidebar.contains(e.target);
      const isClickOnMenuBtn = menuBtn.contains(e.target);
      if (!isClickInsideSidebar && !isClickOnMenuBtn) {
        sidebar.classList.add("sidebar-hidden");
      }
    }
  });
  const pages = document.querySelectorAll(".page");
  document.querySelectorAll(".sidebar a").forEach(a=>{
    a.addEventListener("click", e=>{
      e.preventDefault();
      pages.forEach(p=>p.classList.add("hidden"));
      document.getElementById(a.dataset.page+"Page").classList.remove("hidden");
      document.querySelectorAll(".sidebar a").forEach(x=>x.classList.remove("active"));
      a.classList.add("active");
      if(a.dataset.page==="clientes") carregarClientes();
      if (a.dataset.page === "home") {
        if (typeof atualizarResumosHome === 'function') atualizarResumosHome();
        if (typeof atualizarResumoFinanceiroHome === 'function') atualizarResumoFinanceiroHome();
        renderHomeCalendar();
      }
      // üîπ Atualiza os resumos da home e renderiza o calend√°rio da agenda
      if (a.dataset.page === "agenda") { renderAgendaCalendar(); } else if (a.dataset.page === "financeiro2") {
  const relatorioContainer = document.getElementById("relatorioContainer");
  const toggleBtn = document.getElementById("toggleRelatorioBtn");
  const mesSelector = document.getElementById("relatorioMesSelector");

  // üîπ Garante estado inicial
  relatorioContainer.style.display = "none"; // relat√≥rio oculto

  // üîπ Esconde o bot√£o de carregar relat√≥rio
  if (btnLoadRelatorio) btnLoadRelatorio.style.display = "none"; // Bot√£o j√° n√£o √© mais usado

  // üîπ Carrega os dados da planilha silenciosamente
  fetch("https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc")
    .then(res => res.json())
    .then(data => {
      if (!data.length) return;

      // Corrige formato do m√™s
      data.forEach(i => {
        if (i.MesRef) i.MesRef = i.MesRef.slice(0, 7);
      });

      // Guarda globalmente
      window.financeiroRelatorioData = data;

      // Pega meses √∫nicos
      const meses = [...new Set(data.map(d => d.MesRef).filter(Boolean))].sort().reverse();
      mesSelector.innerHTML = "";
      meses.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        mesSelector.appendChild(opt);
      });

      // Pega o m√™s atual
      const mesAtual = new Date().toISOString().slice(0, 7);
      const mesInicial = meses.includes(mesAtual) ? mesAtual : meses[0];
      mesSelector.value = mesInicial;

      // üîπ Atualiza o dashboard e os resumos com o m√™s atual
      if (typeof atualizarDashboard === "function") atualizarDashboard(mesInicial);
      if (typeof atualizarResumoFinanceiroHome === "function") atualizarResumoFinanceiroHome();

      // Adiciona o listener para o seletor de m√™s AQUI, ap√≥s os dados serem carregados
      mesSelector.removeEventListener("change", handleMesSelectorChange); // Remove listener antigo para evitar duplica√ß√£o
      mesSelector.addEventListener("change", handleMesSelectorChange);

      document.getElementById("relatorioFinanceiro2").classList.remove("hidden");
    })
    .catch(err => console.error("Erro ao carregar relat√≥rio:", err));
}


    });
  });

function handleMesSelectorChange(e) {
    const mes = e.target.value;
    if (typeof atualizarDashboard === "function") atualizarDashboard(mes);
}

let homeCalendar;

async function renderHomeCalendar() {
  const calendarEl = document.getElementById("calendar");
  if (!calendarEl) return;

  if (homeCalendar) homeCalendar.destroy();

  // üîπ Busca eventos da planilha
  let eventos = [];
  try {
    const res = await fetch("https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc/tabs/Agenda");
    const data = await res.json();
    eventos = data
      .filter(e => e.Data && e.Cliente)
      .map(e => ({
        title: `${e.Cliente} - ${e.Procedimento || ""}`,
        start: `${e.Data}T${e.Hora || "00:00"}`,
        allDay: false,
        color: "#a9a9a9",
        textColor: "#fff"
      }));
  } catch (err) {
    console.error("Erro ao carregar eventos:", err);
  }

  // üîπ Define intervalo de 2 semanas
  const today = new Date();
  const twoWeeksLater = new Date();
  twoWeeksLater.setDate(today.getDate() + 13);

  // üîπ Cria o calend√°rio igual √† Agenda (pt-BR, formata√ß√£o e tema neutro)
  homeCalendar = new FullCalendar.Calendar(calendarEl, {
    locale: "pt-br", // üëà idioma
    themeSystem: "standard",
    headerToolbar: {
      left: "",
      center: "title",
      right: ""
    },
    views: {
      twoWeekView: {
        type: "dayGrid",
        duration: { weeks: 2 },
        buttonText: "2 semanas"
      }
    },
    initialView: "twoWeekView",
    initialDate: today,
    visibleRange: { start: today, end: twoWeeksLater },

    // üîπ Layout fluido
    height: "auto",
    contentHeight: "auto",
    expandRows: true,
    aspectRatio: 1.6,

    events: eventos,
    selectable: false,
    editable: false,
    dayMaxEventRows: true,
    eventDisplay: "block",

    // üîπ Formatos de data iguais √† Agenda
    dayHeaderFormat: { weekday: "short" },
    titleFormat: { month: "long", year: "numeric" },
    eventTimeFormat: { hour: "2-digit", minute: "2-digit", hour12: false }
  });

  homeCalendar.render();

  // üîπ Aplica o estilo neutro (igual √† Agenda)
  const style = document.createElement("style");
  style.innerHTML = `
    .fc {
      background-color: #f9f9fb;
      border-radius: 12px;
      padding: 10px;
      color: #2e2e2e;
      font-family: 'Inter', sans-serif;
      border: 1px solid #ddd;
    }

    .fc-toolbar-title {
      color: #333;
      font-weight: 600;
      font-size: 0.2rem;
      text-transform: capitalize;
    }

    .fc-col-header-cell {
      background-color: #f1f1f3;
      color: #555;
      font-weight: 500;
      border: none;
    }

    .fc-daygrid-day {
      background-color: #fff;
      border: 1px solid #e7e7e7;
    }
    .fc-daygrid-day:hover {
      background-color: #efefef;
    }

    .fc-daygrid-event {
      background-color: #a9a9a9 !important;
      color: #fff !important;
      border: none !important;
      border-radius: 6px;
      padding: 2px 6px;
      font-size: 12px;
    }

    .fc-day-today {
      background-color: #e8e8e8 !important;
      border: 1px solid #aaa !important;
    }

    /* Evita barra de rolagem */
    #calendar, .fc, .fc-scrollgrid, .fc-view-harness {
      overflow: visible !important;
    }
  `;
  document.head.appendChild(style);
}

renderHomeCalendar();

// üîπ Chama as fun√ß√µes de atualiza√ß√£o de resumos no carregamento inicial da p√°gina
if (typeof atualizarResumosHome === 'function') {
  atualizarResumosHome();
}

});

const SHEET_AGENDA_URL = "https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc/tabs/Agenda";

let agendaCalendar;

// üîπ Atualiza os resumos da p√°gina HOME para o M√äS ATUAL
async function atualizarResumosHome() {
  const hoje = new Date();
  const ano = hoje.getFullYear();
  const mes = hoje.getMonth() + 1;
  const mesAnoAtual = `${ano}-${String(mes).padStart(2, '0')}`;

  try {
    const res = await fetch(SHEET_AGENDA_URL);
    const eventos = await res.json();

    const eventosDoMes = eventos.filter(e => e.Data && e.Data.startsWith(mesAnoAtual));

const totalAgendamentos = eventosDoMes.length;

  const totalAtendimentos = eventosDoMes.filter(
    e => (e.Presenca || '').trim().toLowerCase() === 'sim'
  ).length;

  // =====================================================
  // üîπ EXTENS√ÉO DE C√çLIOS
  // =====================================================
  const eventosCilios = eventosDoMes.filter(e =>
    (e.Modalidade || '').toLowerCase().includes('c√≠lios')
  );

  const ciliosAplicacoes = eventosCilios.filter(e =>
    (e.Procedimento || '').toLowerCase() === 'aplica√ß√£o'
  ).length;

  const ciliosManutencoes = eventosCilios.filter(e =>
    (e.Procedimento || '').toLowerCase() === 'manuten√ß√£o'
  ).length;

  // =====================================================
  // üîπ SOBRANCELHAS
  // =====================================================
  const eventosSobrancelhas = eventosDoMes.filter(e =>
    (e.Modalidade || '').toLowerCase().includes('sobrancelha')
  );

  const sobraAplicacoes = eventosSobrancelhas.filter(e =>
    (e.Procedimento || '').toLowerCase() === 'aplica√ß√£o'
  ).length;

  const sobraManutencoes = eventosSobrancelhas.filter(e =>
    (e.Procedimento || '').toLowerCase() === 'manuten√ß√£o'
  ).length;

  // =====================================================
  // üîπ ATUALIZA OS CARDS
  // =====================================================

// Agendamentos
const elAgendamentos = document.getElementById("agendamentos");
if (elAgendamentos) {
  elAgendamentos.innerHTML = `
    <span class="numero-grande">${totalAgendamentos}</span>
    <span class="titulo-card">Agendamentos</span>
  `;
}

// Atendimentos
const elAtendimentos = document.getElementById("atendimentos");
if (elAtendimentos) {
  elAtendimentos.innerHTML = `
    <span class="numero-grande">${totalAtendimentos}</span>
    <span class="titulo-card">Atendimentos</span>
  `;
}

// Extens√£o de C√≠lios
const elCiliosTotal = document.getElementById("ciliosTotal");
const elCiliosDetalhe = document.getElementById("ciliosDetalhe");

if (elCiliosTotal) {
  elCiliosTotal.innerHTML = `
    <span class="numero-grande">${eventosCilios.length}</span>
    <span class="titulo-card">Ext. de C√≠lios</span>
  `;
}

// ‚ùó N√ÉO MEXE NOS DETALHES
if (elCiliosDetalhe) {
  elCiliosDetalhe.textContent = `Aplic: ${ciliosAplicacoes} Manut: ${ciliosManutencoes}`;
}

// Sobrancelhas
const elSobraTotal = document.getElementById("sobraTotal");
const elSobraDetalhe = document.getElementById("sobraDetalhe");

if (elSobraTotal) {
  elSobraTotal.innerHTML = `
    <span class="numero-grande">${eventosSobrancelhas.length}</span>
    <span class="titulo-card">Sobrancelhas</span>
  `;
}

// ‚ùó N√ÉO MEXE NOS DETALHES
if (elSobraDetalhe) {
  elSobraDetalhe.textContent = `Aplic: ${sobraAplicacoes} Manut: ${sobraManutencoes}`;
}


} catch (err) {
  console.error("Erro ao atualizar resumos da home:", err);

  const elAgendamentos = document.getElementById("agendamentos");
  const elAtendimentos = document.getElementById("atendimentos");
  const elCiliosTotal = document.getElementById("ciliosTotal");
  const elCiliosDetalhe = document.getElementById("ciliosDetalhe");
  const elSobraTotal = document.getElementById("sobraTotal");
  const elSobraDetalhe = document.getElementById("sobraDetalhe");

  if (elAgendamentos) elAgendamentos.textContent = `Agendamentos -`;
  if (elAtendimentos) elAtendimentos.textContent = `Atendimentos -`;
  if (elCiliosTotal) elCiliosTotal.textContent = `Extens√£o de C√≠lios -`;
  if (elCiliosDetalhe) elCiliosDetalhe.textContent = `Aplic.: - | Manut.: -`;
  if (elSobraTotal) elSobraTotal.textContent = `Sobrancelhas -`;
  if (elSobraDetalhe) elSobraDetalhe.textContent = `Aplic.: - | Manut.: -`;
}
}

// üîπ Atualiza os resumos da p√°gina de agenda
async function atualizarResumosAgenda(data) {
  const dataCalendario = new Date(data.startStr);
  dataCalendario.setMonth(dataCalendario.getMonth() + 1);

  const ano = dataCalendario.getUTCFullYear();
  const mes = dataCalendario.getUTCMonth() + 1;
  const mesAnoAtual = `${ano}-${String(mes).padStart(2, '0')}`;

  try {
    const res = await fetch(SHEET_AGENDA_URL);
    const eventos = await res.json();

    const eventosDoMes = eventos.filter(e => e.Data && e.Data.startsWith(mesAnoAtual));

const totalAgendamentos = eventosDoMes.length;

  const totalAtendimentos = eventosDoMes.filter(
    e => (e.Presenca || '').trim().toLowerCase() === 'sim'
  ).length;

  // üîπ EXTENS√ÉO DE C√çLIOS
  const eventosCilios = eventosDoMes.filter(e =>
    (e.Modalidade || '').toLowerCase().includes('c√≠lios')
  );

  const ciliosAplicacao = eventosCilios.filter(e =>
    (e.Procedimento || '').trim().toLowerCase() === 'aplica√ß√£o'
  ).length;

  const ciliosManutencao = eventosCilios.filter(e =>
    (e.Procedimento || '').trim().toLowerCase() === 'manuten√ß√£o'
  ).length;

  // üîπ SOBRANCELHAS
  const eventosSobra = eventosDoMes.filter(e =>
    (e.Modalidade || '').toLowerCase().includes('sobrancelha')
  );

  const sobraAplicacao = eventosSobra.filter(e =>
    (e.Procedimento || '').trim().toLowerCase() === 'aplica√ß√£o'
  ).length;

  const sobraManutencao = eventosSobra.filter(e =>
    (e.Procedimento || '').trim().trim().toLowerCase() === 'manuten√ß√£o'
  ).length;

  // üîπ ELEMENTOS DA AGENDA
  const elAg = document.getElementById("agendaAgendamentos");
  const elAt = document.getElementById("agendaAtendimentos");
  const elCiliosTotal = document.getElementById("agendaCiliosTotal");
  const elCiliosDet = document.getElementById("agendaCiliosDetalhe");
  const elSobraTotal = document.getElementById("agendaSobraTotal");
  const elSobraDet = document.getElementById("agendaSobraDetalhe");

if (elAg) elAg.innerHTML = `<span class="numero-grande">${totalAgendamentos}</span> Agendamentos`;
if (elAt) elAt.innerHTML = `<span class="numero-grande">${totalAtendimentos}</span> Atendimentos`;

if (elCiliosTotal) {
  elCiliosTotal.innerHTML = `<span class="numero-grande">${eventosCilios.length}</span>Ext. de C√≠lios`;
}

  if (elCiliosDet) {
    elCiliosDet.textContent = `Aplic: ${ciliosAplicacao} Manut: ${ciliosManutencao}`;
  }
if (elSobraTotal) {
  elSobraTotal.innerHTML = `<span class="numero-grande">${eventosSobra.length}</span> Sobrancelhas`;
}

  if (elSobraDet) {
    elSobraDet.textContent = `Aplic: ${sobraAplicacao} Manut: ${sobraManutencao}`;
  }

} catch (err) {
  console.error("Erro ao atualizar resumos da agenda:", err);

  const fallback = {
    agendaAgendamentos: "Agendamentos -",
    agendaAtendimentos: "Atendimentos -",
    agendaCiliosTotal: "Extens√£o de C√≠lios -",
    agendaCiliosDetalhe: "Aplic.: - | Manut.: -",
    agendaSobraTotal: "Sobrancelhas -",
    agendaSobraDetalhe: "Aplic.: - | Manut.: -"
  };

  Object.entries(fallback).forEach(([id, texto]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = texto;
  });
}
}

// üîπ Renderiza o calend√°rio
async function renderAgendaCalendar() {
  const calendarEl = document.getElementById("calendarAgenda");
  if (!calendarEl) return;

  // Destroi o calend√°rio anterior, se existir
  if (agendaCalendar) agendaCalendar.destroy();

  // üîπ Busca eventos da planilha
  let eventos = [];
  try {
    const res = await fetch(SHEET_AGENDA_URL);
    const data = await res.json();
    eventos = data.map(e => ({
      id: `${e.Data}-${e.Hora}-${e.Cliente}`, // ID √∫nico para o evento
      title: `${e.Cliente} - ${e.Procedimento || ''}`,
      start: `${e.Data}T${e.Hora || "00:00"}`,
      color: e.Presenca === 'Sim' ? '#22c55e' : '#f4bfae', // Verde se presente, rosa padr√£o sen√£o
      allDay: false,
      extendedProps: {
        id: e.ID, // üîë Pega o ID √∫nico da planilha
        cliente: e.Cliente,
        procedimento: e.Procedimento, // üîë Adiciona o procedimento
        modalidade: e.Modalidade,
        tipo: e.Tipo,
        cep: e.CEP, // Assumindo que o e-mail est√° na coluna CEP
        Presenca: e.Presenca // üîë Adiciona a presen√ßa
      }
    }));
  } catch (err) {
    console.error("Erro ao carregar eventos:", err);
  }

  // üîπ Cria o calend√°rio
  agendaCalendar = new FullCalendar.Calendar(calendarEl, {
    initialView: "dayGridMonth",
    locale: "pt-br",
    height: 600,
    selectable: true,
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "dayGridMonth,timeGridWeek,timeGridDay"
    },
    buttonText: {
      today: "Hoje",
      month: "M√™s",
      week: "Semana",
      day: "Dia"
    },
    events: eventos,

    // üîπ Abre o modal para NOVO agendamento ao clicar numa data
    dateClick: function(info) {
      eventoEmEdicao = null; // Garante que n√£o estamos em modo de edi√ß√£o
      document.getElementById("formAgendamento").reset();
      document.getElementById("agendamentoData").value = info.dateStr;
      document.getElementById("btnSalvarAgendamentoTexto").textContent = "Agendar";
      document.getElementById("btnExcluirAgendamento").classList.add("hidden");
      document.getElementById("campoPresenca").classList.add("hidden"); // Esconde o campo de presen√ßa
      abrirModalAgendamento();
    },

// üîπ Abre o modal para EDITAR agendamento ao clicar num evento
eventClick: function(info) {
  eventoEmEdicao = null;

  // üîë Guarda os dados ORIGINAIS do agendamento para encontrar a linha certa
  const props = info.event.extendedProps;
  eventoEmEdicao = {
    id: props.id, // üîë Armazena o ID √∫nico do evento
    clienteOriginal: props.cliente,
    dataOriginal: info.event.start.toISOString().slice(0, 10),
    horaOriginal: ('0' + info.event.start.getHours()).slice(-2) + ':' + ('0' + info.event.start.getMinutes()).slice(-2),
    procedimentoOriginal: props.procedimento || "",
    event: info.event
  };

  console.log("üü° AGENDAMENTO EM EDI√á√ÉO:", eventoEmEdicao);

  // üßæ Preenche o formul√°rio
  document.getElementById("agendamentoCliente").value = props.cliente || "";

  // üîπ Garante que o e-mail (CEP) seja carregado a partir dos dados mais recentes do cliente
  const clienteSelecionado = clientesData.find(c => c.Nome === props.cliente);
  document.getElementById("agendamentoCep").value = clienteSelecionado ? clienteSelecionado.CEP : "";


  document.getElementById("agendamentoProcedimento").value = props.procedimento || "";
  document.getElementById("agendamentoModalidade").value = props.modalidade || "";
  document.getElementById("agendamentoTipo").value = props.tipo || "";

  // Preenche e exibe o campo de presen√ßa
  document.getElementById("agendamentoPresenca").checked = (props.Presenca || "").toLowerCase() === 'sim';
  document.getElementById("campoPresenca").classList.remove("hidden");

  // üìÖ Data e hora (SEGURAS)
  document.getElementById("agendamentoData").value = eventoEmEdicao.dataOriginal;
  document.getElementById("agendamentoHora").value = eventoEmEdicao.horaOriginal;

  document.getElementById("btnSalvarAgendamentoTexto").textContent = "Salvar Altera√ß√µes";
  document.getElementById("btnExcluirAgendamento").classList.remove("hidden");

  abrirModalAgendamento();
},


    eventDrop: async function(info) {
      if (!confirm("Tem certeza que deseja mover este agendamento?")) {
        info.revert();
        return;
      }
      // L√≥gica para atualizar o evento na planilha ap√≥s o drag-and-drop
      // (semelhante √† l√≥gica de edi√ß√£o)
      console.log("Evento movido para:", info.event.start);
      // Aqui voc√™ chamaria a fun√ß√£o de atualiza√ß√£o na planilha
    },

    eventResize: async function(info) {
      // L√≥gica para quando a dura√ß√£o de um evento √© alterada
      console.log("Evento redimensionado.");
    },

    // üîπ Atualiza os resumos ao mudar de m√™s/view
    datesSet: function(dateInfo) {
      // A fun√ß√£o √© chamada com a view atual para pegar o m√™s correto
      atualizarResumosAgenda(dateInfo);
    }




  });

  agendaCalendar.render();
}

// üîπ Abre o modal de agendamento com anima√ß√£o
function abrirModalAgendamento() {
  const modal = document.getElementById("modalAgendamento");
  const content = document.getElementById("modalAgendamentoContent");
  modal.classList.remove("hidden");
  setTimeout(() => {
    content.classList.remove("scale-95", "opacity-0");
    content.classList.add("scale-100", "opacity-100");
  }, 10);
}

document.addEventListener("DOMContentLoaded", () => {
  const formAgendamento = document.getElementById("formAgendamento");
  const modalAgendamento = document.getElementById("modalAgendamento");
  const modalAgendamentoContent = document.getElementById("modalAgendamentoContent");
  const SHEET_ANAMNESE_URL = "https://api.sheetbest.com/sheets/47c25a09-7224-4984-b97f-602988cf54dc/tabs/Anamnese";

  // --- MODAL DE AGENDAMENTO ---

  // üîπ Fechar modal de agendamento
  document.getElementById("fecharModalAgendamento").addEventListener("click", () => {
    modalAgendamentoContent.classList.remove("scale-100", "opacity-100");
    modalAgendamentoContent.classList.add("scale-95", "opacity-0");
    setTimeout(() => modalAgendamento.classList.add("hidden"), 250);
  });

  // üîπ Excluir agendamento
  document.getElementById("btnExcluirAgendamento").addEventListener("click", async () => {
    if (!eventoEmEdicao || !confirm("Tem certeza que deseja excluir este agendamento?")) {
      return;
    }

    try {
      // Agora exclui usando o ID √∫nico, que √© muito mais seguro
      const url = `${SHEET_AGENDA_URL}/ID/${eventoEmEdicao.id}`;

      const response = await fetch(url, { method: "DELETE" });

      if (!response.ok) {
        throw new Error("Falha ao excluir o agendamento na planilha.");
      }

      alert("‚úÖ Agendamento exclu√≠do com sucesso!");

      eventoEmEdicao.event.remove(); // Remove do calend√°rio
      eventoEmEdicao = null;
      modalAgendamento.classList.add("hidden");

    } catch (err) {
      console.error("Erro ao excluir agendamento:", err);
      alert("‚ùå Erro ao excluir agendamento. A API pode n√£o ter encontrado o registro exato.");
    }
  });

  // üîπ Salvar (criar/editar) agendamento
  formAgendamento.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(formAgendamento);
    const evento = Object.fromEntries(formData.entries());
    const editando = !!eventoEmEdicao;
    const enviarEmail = document.getElementById("enviarEmail").checked;
    let abrirAnamnese = false;

    // Adiciona o valor da presen√ßa ao objeto do evento, j√° que o checkbox n√£o tem 'name'
    evento.Presenca = document.getElementById("agendamentoPresenca").checked ? "Sim" : "N√£o";

    try {
      // 1. Se estiver editando, primeiro exclui o registro antigo.
      if (editando) {
        // üí° VERIFICA SE A PRESEN√áA FOI MARCADA AGORA
        const presencaOriginal = (eventoEmEdicao.event.extendedProps.Presenca || "N√£o").toLowerCase();
        if (presencaOriginal === 'n√£o' && evento.Presenca.toLowerCase() === 'sim') {
          abrirAnamnese = true;
        }

        const deleteResponse = await fetch(`${SHEET_AGENDA_URL}/ID/${eventoEmEdicao.id}`, {
          method: "DELETE",
        });

        if (!deleteResponse.ok) {
          throw new Error("Falha ao remover o registro antigo durante a edi√ß√£o.");
        }
      }

      // 2. Em seguida, cria um novo registro (tanto para novos agendamentos quanto para edi√ß√µes).
      // Busca o √∫ltimo ID para gerar um novo sequencial
      const res = await fetch(SHEET_AGENDA_URL);
      const agendamentos = await res.json(); // Pega todos os agendamentos para calcular o pr√≥ximo ID
      
      const maxId = agendamentos.reduce((max, item) => {
          const currentId = parseInt(item.ID, 10);
          return !isNaN(currentId) && currentId > max ? currentId : max;
      }, 99);
      evento.ID = maxId + 1; // Atribui o pr√≥ximo ID sequencial

      // 3. Envia o novo registro (com os dados do formul√°rio e o novo ID) para a planilha
      const createResponse = await fetch(SHEET_AGENDA_URL, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json"
          },
          body: JSON.stringify(evento),
        });

      if (!createResponse.ok) throw new Error("Erro ao salvar o novo agendamento na planilha.");

      alert("‚úÖ Agendamento salvo com sucesso!");
      
      console.log("‚úÖ Agendamento salvo. Enviando e-mail...");

      // Verifica se a √∫nica mudan√ßa foi na presen√ßa durante uma edi√ß√£o
      let apenasPresencaMudou = false;
      if (editando) {
        const presencaOriginal = (eventoEmEdicao.event.extendedProps.Presenca || "N√£o").toLowerCase();
        const presencaNova = evento.Presenca.toLowerCase();
        // Simplificando: se a presen√ßa mudou, consideramos que foi a √∫nica altera√ß√£o para n√£o enviar e-mail.
        // Uma l√≥gica mais complexa compararia todos os outros campos.
        if (presencaOriginal !== presencaNova) apenasPresencaMudou = true;
      }

      // üîπ Envia o e-mail via EmailJS
      if (enviarEmail && !apenasPresencaMudou) {
        try {
          const resultadoEmail = await emailjs.send(
            "service_j2axhfl",
            "template_2jvgelm",
            {
              cliente: evento.Cliente,
              data: evento.Data,
              hora: evento.Hora,
              procedimento: evento.Procedimento,
              tipo: evento.Tipo,
              cep: evento.CEP
            }
          );

          console.log("üì® E-mail enviado com sucesso:", resultadoEmail);
        } catch (emailErr) {
          console.error("‚ùå Erro ao enviar e-mail via EmailJS:", emailErr);
          alert("‚ö†Ô∏è Agendamento salvo, mas falha ao enviar e-mail.");
        }
      }

      formAgendamento.reset();
      modalAgendamento.classList.add("hidden");
      // Aguarda 2 segundos e redesenha o calend√°rio, mantendo o usu√°rio na p√°gina da agenda
      setTimeout(async () => {
        await renderAgendaCalendar();
        // üí° ABRE A ANAMNESE AP√ìS ATUALIZAR O CALEND√ÅRIO
        if (abrirAnamnese) {
          abrirModalAnamnese(evento);
        }
      }, 2000);
    } catch (err) {
      console.error("Erro ao salvar agendamento:", err);
      alert("‚ùå Erro ao salvar agendamento. Verifique os dados e a conex√£o.");
    }
  });

  // --- MODAL DE ANAMNESE ---
  const modalAnamnese = document.getElementById("modalAnamnese");
  const modalAnamneseContent = document.getElementById("modalAnamneseContent");
  const canvas = document.getElementById("signature-pad");
  const signaturePad = new SignaturePad(canvas);

  window.abrirModalAnamnese = async (dadosAgendamento) => {
    document.getElementById("formAnamnese").reset();
    signaturePad.clear();

    // Busca dados completos do cliente
    const clienteCompleto = clientesData.find(c => c.Nome === dadosAgendamento.Cliente);

    // Preenche Bloco 1
    document.getElementById("anamneseData").value = dadosAgendamento.Data;
    document.querySelector("#anamneseNome").textContent = dadosAgendamento.Cliente;
    
    if (clienteCompleto) {
      document.querySelector("#anamneseCpf").textContent = clienteCompleto.CPF || '-';
      
      document.querySelector("#anamneseTelefone").textContent = clienteCompleto.Telefone || '-';
      
      document.querySelector("#anamneseDn").textContent = clienteCompleto.DN ? formatarDataEIdade(clienteCompleto.DN, true) : '-';
      
    }

    // Preenche Bloco 4
    document.getElementById("anamneseModalidade").value = dadosAgendamento.Modalidade || '';
    document.getElementById("anamneseProcedimento").value = dadosAgendamento.Procedimento || '';
    const agora = new Date();
    document.getElementById("anamneseHorarioInicio").value = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

    // Mostra o modal
    modalAnamnese.classList.remove("hidden");
    setTimeout(() => {
      modalAnamneseContent.classList.remove("scale-95", "opacity-0");
      modalAnamneseContent.classList.add("scale-100", "opacity-100");
      signaturePad.fromData(signaturePad.toData()); // Redesenha o canvas
    }, 10);
  };

  // L√≥gica para campos condicionais
  document.querySelectorAll('input[name="Alergia"]').forEach(r => r.addEventListener('change', e => {
    document.getElementById('campoAlergiaQuais').classList.toggle('hidden', e.target.value !== 'Sim');
  }));
  document.querySelectorAll('input[name="Doenca"]').forEach(r => r.addEventListener('change', e => {
    document.getElementById('campoDoencaQuais').classList.toggle('hidden', e.target.value !== 'Sim');
  }));

  // Limpar assinatura
  document.getElementById("clear-signature").addEventListener("click", () => signaturePad.clear());

  // Fechar modal
  document.getElementById("fecharModalAnamnese").addEventListener("click", () => {
    modalAnamneseContent.classList.remove("scale-100", "opacity-100");
    modalAnamneseContent.classList.add("scale-95", "opacity-0");
    setTimeout(() => modalAnamnese.classList.add("hidden"), 250);
  });

  // Salvar Anamnese
  document.getElementById("formAnamnese").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (signaturePad.isEmpty()) return alert("Por favor, preencha a assinatura.");

    const formData = new FormData(e.target);
    const anamneseData = Object.fromEntries(formData.entries());

    // üí° Adiciona manualmente os dados do cliente que n√£o est√£o mais no formul√°rio vis√≠vel
    const clienteCompleto = clientesData.find(c => c.Nome === document.querySelector("#anamneseNome").textContent);
    anamneseData.Nome = clienteCompleto?.Nome || '';
    anamneseData.CPF = clienteCompleto?.CPF || '';
    anamneseData.Telefone = clienteCompleto?.Telefone || '';
    anamneseData.DN = clienteCompleto?.DN || '';

    anamneseData.Assinatura = `=IMAGE("${signaturePad.toDataURL()}")`; // üí° Salva como f√≥rmula de imagem para o Google Sheets

    try {
      const response = await fetch(SHEET_ANAMNESE_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(anamneseData) });
      if (!response.ok) throw new Error("Erro ao salvar anamnese.");
      alert("‚úÖ Anamnese salva com sucesso!");
      document.getElementById("fecharModalAnamnese").click();
    } catch (err) {
      console.error("Erro ao salvar anamnese:", err);
      alert("‚ùå Erro ao salvar anamnese na planilha.");
    }
  });
});

const canvas = document.getElementById("signature-pad");
const ctx = canvas.getContext("2d");

let desenhando = false;

// üîπ Ajusta o canvas ao tamanho real vis√≠vel (ESSENCIAL)
function ajustarCanvas() {
  const rect = canvas.getBoundingClientRect();
  const ratio = window.devicePixelRatio || 1;

  canvas.width = rect.width * ratio;
  canvas.height = rect.height * ratio;

  ctx.scale(ratio, ratio);

  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#000";
}

// üîπ Posi√ß√£o correta do toque/mouse
function getPosicao(event) {
  const rect = canvas.getBoundingClientRect();

  let clientX, clientY;

  if (event.touches) {
    clientX = event.touches[0].clientX;
    clientY = event.touches[0].clientY;
  } else {
    clientX = event.clientX;
    clientY = event.clientY;
  }

  return {
    x: clientX - rect.left,
    y: clientY - rect.top
  };
}

// üîπ In√≠cio
function iniciar(event) {
  event.preventDefault();
  desenhando = true;

  const pos = getPosicao(event);
  ctx.beginPath();
  ctx.moveTo(pos.x, pos.y);
}

// üîπ Movimento
function desenhar(event) {
  if (!desenhando) return;
  event.preventDefault();

  const pos = getPosicao(event);
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();
}

// üîπ Fim
function parar() {
  desenhando = false;
}

// üîπ Eventos
canvas.addEventListener("mousedown", iniciar);
canvas.addEventListener("mousemove", desenhar);
canvas.addEventListener("mouseup", parar);
canvas.addEventListener("mouseleave", parar);

canvas.addEventListener("touchstart", iniciar, { passive: false });
canvas.addEventListener("touchmove", desenhar, { passive: false });
canvas.addEventListener("touchend", parar);

// üîπ Limpar assinatura
document.getElementById("clear-signature").addEventListener("click", () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
});

// üîπ Ajusta ao abrir o modal
ajustarCanvas();
window.addEventListener("resize", ajustarCanvas);

function abrirModalAnamnese() {
  const modal = document.getElementById("modalAnamnese");
  modal.classList.remove("hidden");
  document.body.style.overflow = "hidden"; // trava scroll do fundo
}

function fecharModalAnamnese() {
  const modal = document.getElementById("modalAnamnese");
  modal.classList.add("hidden");
  document.body.style.overflow = ""; // libera scroll
}
</script>
</body>
</html>