 <!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/png" href="Assets/icon.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gest√£o Studio Sa Lopes</title>

<!-- Tailwind CSS -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/main.global.min.js"></script>

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- Manifest (PWA) -->
<link rel="manifest" href="manifest.json">

<style>
  :root {
    --fundo: #1e1e1e;
    --rose: #f4bfae;
    --texto: #ffffff;
  }

  body {
    background-color: var(--fundo);
    color: var(--texto);
    font-family: 'Inter', sans-serif;
  }

  .sidebar {
    background-color: #111111;
    color: var(--rose);
    transition: transform 0.3s ease;
  }

  .sidebar a {
    display: block;
    padding: 12px 20px;
    border-radius: 8px;
    color: var(--rose);
    text-decoration: none;
    margin-bottom: 4px;
    transition: background 0.2s;
  }

  .sidebar a:hover, .sidebar a.active {
    background-color: var(--rose);
    color: #111111;
  }

  .sidebar.hidden { transform: translateX(-100%); }

  .card {
    background-color: #252525;
    color: var(--rose);
    border: 1px solid #3a3a3a;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 50;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    justify-content: center; align-items: center;
  }

  .modal-content {
    background: #2b2b2b;
    color: var(--rose);
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 800px;
    max-height: 90%;
    overflow-y: auto;
  }

  .btn-primary {
    background-color: var(--rose);
    color: #111;
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    background-color: #ffd2c2;
  }

.card-footer {
  background: linear-gradient(to bottom, #b88c7a, #f4bfae);
  box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
  cursor: pointer;
  overflow: hidden;
  transition: all 0.4s ease;
  max-height: 12px; /* apenas a barrinha vis√≠vel inicialmente */

  position: relative;
  z-index: 1;         /* üîπ fica por baixo do card */
  margin-top: -14px;  /* üîπ empurra para tr√°s do card */
}

.card-footer.open {
  max-height: 200px; /* altura expandida ao abrir */
  padding: 10px;
}

.card-footer-content {
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.4s ease;
}

.card-footer.open .card-footer-content {
  opacity: 1;
  transform: translateY(0);
}

.cliente-card {
  position: relative;
  z-index: 5; /* üîπ card acima da faixa */
  background-color: #2b2b2b;
  border-radius: 1rem;
  box-shadow:
    0 3px 8px rgba(0, 0, 0, 0.45),
  /*transition: all 0.3s ease;*/
}

.cliente-card:hover {
  box-shadow:
    0 5px 14px rgba(0, 0, 0, 0.6),
    inset 0 0 10px rgba(12, 12, 12, 0.15);
  transform: translateY(-2px);
  background-color: #2f2f2f;
}



</style>
</head>
<body class="flex h-screen">

<!-- Sidebar -->
<aside id="sidebar" class="sidebar w-64 p-5 flex flex-col fixed inset-y-0 left-0 z-40 hidden">
  <h1 class="text-2xl font-semibold mb-8 text-center">Menu</h1>
  <nav class="flex flex-col space-y-2">
    <a href="#" class="active" data-page="home">Home</a>
    <a href="#" data-page="clientes">Clientes</a>
    <a href="#" data-page="agenda">Agenda</a>
    <a href="#" data-page="financeiro2">Financeiro</a>
  </nav>
</aside>

<!-- Bot√£o de menu -->
<button id="menuBtn" class="absolute top-5 left-5 p-2 rounded-md shadow-md z-50">
  <span style="color: var(--rose);" class="text-2xl">‚ò∞</span>
</button>

<!-- Conte√∫do principal -->
<main class="flex-1 p-10 overflow-y-auto ml-0">

  <!-- HOME -->
  <div id="homePage" class="page">
    <div class="text-center mb-8">
      <img src="Assets/logo.png" alt="Logo Studio Sa Lopes" class="mx-auto mb-4" style="width:320px;" onerror="this.onerror=null;">
      <h2 class="text-3xl font-bold text-rose-300" style="display:none;">Gest√£o Studio Sa Lopes</h2>
    </div>

    <div class="grid grid-cols-3 gap-5 mb-5">
      <div class="card p-5 rounded-xl shadow flex items-center justify-center font-bold text-lg" id="atendimentos">Atendimentos: 0</div>
      <div class="card p-5 rounded-xl shadow flex items-center justify-center font-bold text-lg" id="agendamentos">Agendamentos: 0</div>
      <div class="card p-5 rounded-xl shadow grid grid-rows-2 text-center font-bold">
        <div id="Aplica√ß√£o">Aplica√ß√£o: 0</div>
        <div id="manutencao">Manuten√ß√µes: 0</div>
      </div>
    </div>

    <div class="card rounded-xl shadow p-5 mb-5">
      <div id="calendar" class="w-full" style="height: 400px;"></div>
    </div>

<div class="card rounded-xl shadow p-5 flex flex-col justify-center" id="resumoFinanceiro">
  <h3 class="text-lg font-bold mb-4">üí∞ Resumo Financeiro</h3>
  <div class="grid grid-cols-3 gap-5">
    <div class="card p-4 rounded-xl shadow text-center bg-[#2b2b2b] text-white" id="resumoReceita">
      <h4 class="font-semibold mb-2">‚ÜóÔ∏è Receita</h4>
      <p class="text-2xl">R$ 0,00</p>
    </div>
    <div class="card p-4 rounded-xl shadow text-center bg-[#2b2b2b] text-white" id="resumoDespesa">
      <h4 class="font-semibold mb-2">‚ÜòÔ∏è Despesa</h4>
      <p class="text-2xl">R$ 0,00</p>
    </div>
    <div class="card p-4 rounded-xl shadow text-center bg-[#2b2b2b] text-white" id="resumoSaldo">
      <h4 class="font-semibold mb-2">üíµ Saldo</h4>
      <p class="text-2xl">R$ 0,00</p>
    </div>
  </div>
</div>
</div>

    <!-- CLIENTES -->
  <div id="clientesPage" class="page hidden">
    <div class="flex justify-between mb-5 items-center">
      <h2 class="text-2xl font-bold text-rose-300 ml-4">Clientes</h2>
      <button id="btnAdicionarCliente" class="btn-primary px-4 py-2 rounded-md mr-4">Adicionar Cliente</button>
    </div>
    <div class="mb-5 ml-4">
      <label class="block mb-2 font-semibold text-rose-300">Filtro por Status:</label>
      <div class="flex gap-4">
        <label class="flex items-center">
          <input type="radio" name="filtroStatus" value="todos" checked class="mr-2">
          Todos
        </label>
        <label class="flex items-center">
          <input type="radio" name="filtroStatus" value="Ativo" class="mr-2">
          Ativo
        </label>
        <label class="flex items-center">
          <input type="radio" name="filtroStatus" value="Inativo" class="mr-2">
          Inativo
        </label>
      </div>
    </div>
    <div id="boxCliente" class="card rounded-xl shadow p-5 mt-6 max-w-xl mx-auto hidden">
      <h2 id="tituloCliente" class="text-xl font-bold mb- text-rose-300">Cadastro de Cliente</h2>
      <form id="formCliente" class="space-y-4">
        <div>
          <label class="block mb-1 font-semibold" for="clienteNome">NOME</label>
          <input type="text" id="clienteNome" name="Nome" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="clienteCpf">CPF</label>
          <input type="text" id="clienteCpf" name="CPF" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="clienteTelefone">TELEFONE</label>
          <input type="text" id="clienteTelefone" name="Telefone" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="clienteDn">DN</label>
          <input type="date" id="clienteDn" name="DN" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="clienteEnderecoNum">ENDERE√áO_NUM</label>
          <input type="text" id="clienteEnderecoNum" name="Endereco" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="clienteCep">CEP</label>
          <input type="text" id="clienteCep" name="CEP" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="clienteInstagram">INSTAGRAM</label>
          <input type="text" id="clienteInstagram" name="Instagram" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300">
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="clienteStatus">STATUS</label>
          <select id="clienteStatus" name="Status" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
            <option value="Ativo">Ativo</option>
            <option value="Inativo">Inativo</option>
          </select>
        </div>
        <div class="flex justify-end gap-3 mt-6">
          <button type="button" id="fecharBoxCliente" class="btn-primary px-4 py-2 rounded-md">Fechar</button>
          <button type="submit" class="btn-primary px-4 py-2 rounded-md">Salvar</button>
        </div>
      </form>
    </div>
    <div class="mt-6 ml-4">
      <div id="listaClientes" class="space-y-4">
      </div>
    </div>
  </div>

  <!-- AGENDA -->
  <div id="agendaPage" class="page hidden">
    <div class="flex justify-between mb-5 items-center">
      <h2 class="text-2xl font-bold text-rose-300 ml-4">Agenda</h2>
      <div class="relative mr-4">
        <button id="btnAnamnese" class="btn-primary px-4 py-2 rounded-md">Adicionar Anamnese</button>
        <div id="boxAnamnese" class="absolute right-0 mt-2 w-96 card rounded-xl shadow p-5 z-50 hidden">
          <h2 class="text-xl font-bold mb-4 text-rose-300">Cadastro de Anamnese</h2>
          <form id="formAnamneseBox" class="space-y-4">
            <div>
              <label class="block mb-1 font-semibold" for="anamneseNomeBox">Nome</label>
              <input type="text" id="anamneseNomeBox" name="nome" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
            </div>
            <div>
              <label class="block mb-1 font-semibold" for="anamneseCpfBox">CPF</label>
              <input type="text" id="anamneseCpfBox" name="cpf" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
            </div>
            <div>
              <label class="block mb-1 font-semibold" for="anamneseEnderecoBox">Endere√ßo</label>
              <input type="text" id="anamneseEnderecoBox" name="endereco" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
            </div>
            <div>
              <label class="block mb-1 font-semibold" for="anamneseTelefoneBox">Telefone</label>
              <input type="text" id="anamneseTelefoneBox" name="telefone" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
            </div>
            <div>
              <label class="block mb-1 font-semibold" for="anamneseEmailBox">Email</label>
              <input type="email" id="anamneseEmailBox" name="email" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
            </div>
            <div class="flex justify-end gap-3 mt-6">
              <button type="button" id="fecharBoxAnamnese" class="btn-primary px-4 py-2 rounded-md">Fechar</button>
              <button type="submit" class="btn-primary px-4 py-2 rounded-md">Salvar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div id="calendarAgenda" class="w-full" style="height: 600px;"></div>
    <div id="boxAnamnese" class="card rounded-xl shadow p-5 mt-6 max-w-xl mx-auto hidden">
      <h2 class="text-xl font-bold mb-4 text-rose-300">Cadastro de Anamnese</h2>
      <form id="formAnamneseBox" class="space-y-4">
        <div>
          <label class="block mb-1 font-semibold" for="anamneseNomeBox">Nome</label>
          <input type="text" id="anamneseNomeBox" name="nome" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="anamneseCpfBox">CPF</label>
          <input type="text" id="anamneseCpfBox" name="cpf" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="anamneseEnderecoBox">Endere√ßo</label>
          <input type="text" id="anamneseEnderecoBox" name="endereco" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="anamneseTelefoneBox">Telefone</label>
          <input type="text" id="anamneseTelefoneBox" name="telefone" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="anamneseEmailBox">Email</label>
          <input type="email" id="anamneseEmailBox" name="email" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
        </div>
        <div class="flex justify-end gap-3 mt-6">
          <button type="button" id="fecharBoxAnamnese" class="btn-primary px-4 py-2 rounded-md">Fechar</button>
          <button type="submit" class="btn-primary px-4 py-2 rounded-md">Salvar</button>
        </div>
      </form>
    </div>
  </div>
  
    <!-- FINANCEIRO 2 --> 
    <div id="financeiro2Page" class="page hidden">
<div class="flex justify-between mb-5 items-center">
  <h2 class="text-2xl font-bold text-rose-300 ml-4">Financeiro</h2>
  <div class="flex gap-3 mr-4">
    <button id="btnAdicionarOcorrencia" class="btn-primary px-4 py-2 rounded-md">+ Ocorr√™ncia</button>
    <button id="btnLoadRelatorio" class="btn-primary px-4 py-2 rounded-md">Relat√≥rio</button>
  </div>
</div>

      <div id="boxFinanceiro2" class="card rounded-xl shadow p-5 max-w-xl mx-auto hidden">
        <form id="formFinanceiro2" class="space-y-4" action="https://api.sheetbest.com/sheets/8846f338-a3ea-446c-894b-31fc8ada7191" method="post">
          <div>
            <label class="block mb-1 font-semibold" for="financeiroDtRegistro">Data de Registro</label>
            <input type="date" id="financeiroDtRegistro" name="DtRegistro" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
          </div>

          <div>
            <label class="block mb-1 font-semibold" for="financeiroTipo">Tipo</label>
            <select id="financeiroTipo" name="Tipo" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
              <option value="" disabled selected>Selecione o Tipo</option>
              <option value="Despesas">Despesas</option>
              <option value="Ganhos">Ganhos</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 font-semibold" for="financeiroFamilia">Fam√≠lia</label>
            <select id="financeiroFamilia" name="Familia" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required disabled>
              <option value="" disabled selected>Selecione a Fam√≠lia</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 font-semibold" for="financeiroNome">Nome</label>
            <select id="financeiroNome" name="Nome" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required disabled>
              <option value="" disabled selected>Selecione o Nome</option>
            </select>
          </div>

          <div>
            <label class="block mb-1 font-semibold" for="financeiroDescricao">Descri√ß√£o</label>
            <input type="text" id="financeiroDescricao" name="Descricao" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
          </div>
          <div>
            <label class="block mb-1 font-semibold" for="financeiroValor">Valor</label>
            <input type="number" id="financeiroValor" name="Valor" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
          </div>
          <div>
<label class="block mb-1 font-semibold" for="financeiroMesRef">M√™s de Refer√™ncia</label>
<input type="month" id="financeiroMesRef" name="MesRef" class="w-full p-2 rounded bg-[#1e1e1e] border border-rose-300 text-rose-300" required>
          </div>
          <div class="flex justify-end gap-3 mt-6">
            <button type="button" id="fecharBoxFinanceiro2" class="btn-primary px-4 py-2 rounded-md">Fechar</button>
            <button type="submit" class="btn-primary px-4 py-2 rounded-md">Enviar</button>
          </div>
        </form>
      </div>
<div id="relatorioFinanceiro2" class="card rounded-xl shadow p-5 mx-auto mt-6 hidden" style="width: 100%; display: flex; flex-direction: column; gap: 1rem;">
        <h3 class="text-xl font-bold mb-4 text-rose-300 flex justify-between items-center">
          Relat√≥rio Financeiro
<input type="month" 
       id="relatorioMesSelector" 
       class="bg-[#1e1e1e] border border-rose-300 rounded p-1 text-xs text-black w-[130px]" 
       title="Selecione o m√™s">
                                                                                                                                        

        </h3>
<div id="relatorioDashboard" class="grid grid-cols-3 gap-4 mb-4 max-w-full">
          <div class="card p-4 rounded-xl shadow text-center bg-[#2b2b2b] text-white">
            <h4 class="font-semibold mb-2">Receita</h4>
            <p id="dashboardReceita" class="text-2xl">R$0</p>
          </div>
          <div class="card p-4 rounded-xl shadow text-center bg-[#2b2b2b] text-white">
            <h4 class="font-semibold mb-2">Despesas</h4>
            <p id="dashboardDespesa" class="text-2xl">R$0</p>
          </div>
          <div class="card p-4 rounded-xl shadow text-center bg-[#2b2b2b] text-white">
            <h4 class="font-semibold mb-2">Saldo</h4>
            <p id="dashboardSaldo" class="text-2xl">R$0</p>
          </div>
        </div>


<div id="relatorioResumoDetalhado" class="bg-[#2b2b2b] text-white p-4 rounded-xl shadow w-full mb-2 font-mono whitespace-pre-wrap" style="font-size: 0.85rem; max-height: 800px; overflow-y: auto;"></div>
<button id="toggleRelatorioBtn" style="display:none;">+</button>

<div id="relatorioContainer" style="display:none; Font-size: 0.65rem; max-height: 800px; overflow-y: auto; background-color: #2b2b2b; color: white; padding: 1rem; border-radius: 0.5rem;">
  <!-- conte√∫do do relat√≥rio -->
  <p>Relat√≥rio carregado aqui</p>
</div>
      </div>
  </div>
<script>
const financeiroData = {
  'Despesas': {
    'Despesas Fixas': ['Aluguel', '√Ågua', 'Internet e Telefone', 'Outros'],
    'Despesas Vari√°veis': ['Compras de Insumos', 'Combust√≠vel'],
    'Marketing e Divulga√ß√£o': ['An√∫ncios Pagos', 'Impress√µes de Cart√µes, Panfletos e Brindes', 'Outros'],
    'Infraestrutura e Equipamentos': ['M√≥veis', 'Acess√≥rios', 'Ferramentas'],
    'Despesas Administrativas': ['Taxas Banc√°rias e Outras'],
    'Despesas Extras ou Opcionais': ['Cursos de atualiza√ß√£o e especializa√ß√£o', 'Uniformes personalizados', 'Caf√©, √°gua, snacks para o atendimento', 'Presentes em datas comemorativas']
  },
  'Ganhos': {
    'C√≠lios': ['Aplica√ß√£o', 'Manuten√ß√£o'],
    'Sobrancelhas': ['Aplica√ß√£o', 'Manuten√ß√£o']
  }
};

const financeiroTipo = document.getElementById('financeiroTipo');
const financeiroFamilia = document.getElementById('financeiroFamilia');
const financeiroNome = document.getElementById('financeiroNome');
const btnAdicionarOcorrencia = document.getElementById("btnAdicionarOcorrencia");
const boxFinanceiro2 = document.getElementById("boxFinanceiro2");
const btnLoadRelatorio = document.getElementById("btnLoadRelatorio");
const relatorioDiv = document.getElementById("relatorioFinanceiro2");
const relatorioContainer = document.getElementById("relatorioContainer");
const resumoDetalhadoDiv = document.getElementById("relatorioResumoDetalhado");

// New event listeners for cascading selects in financeiro2 form
financeiroTipo.addEventListener("change", () => {
  const tipo = financeiroTipo.value;
  // Clear and disable familia and nome selects initially
  financeiroFamilia.innerHTML = '<option value="" disabled selected>Selecione a Fam√≠lia</option>';
  financeiroNome.innerHTML = '<option value="" disabled selected>Selecione o Nome</option>';
  financeiroFamilia.disabled = true;
  financeiroNome.disabled = true;

  if (tipo && financeiroData[tipo]) {
    // Populate familia options
    Object.keys(financeiroData[tipo]).forEach(familia => {
      const opt = document.createElement("option");
      opt.value = familia;
      opt.textContent = familia;
      financeiroFamilia.appendChild(opt);
    });
    financeiroFamilia.disabled = false;
  }
});

financeiroFamilia.addEventListener("change", () => {
  const tipo = financeiroTipo.value;
  const familia = financeiroFamilia.value;
  // Clear and disable nome select initially
  financeiroNome.innerHTML = '<option value="" disabled selected>Selecione o Nome</option>';
  financeiroNome.disabled = true;

  if (tipo && familia && financeiroData[tipo] && financeiroData[tipo][familia]) {
    // Populate nome options
    financeiroData[tipo][familia].forEach(nome => {
      const opt = document.createElement("option");
      opt.value = nome;
      opt.textContent = nome;
      financeiroNome.appendChild(opt);
    });
    financeiroNome.disabled = false;
  }
});

// New submit event listener to prevent redirect on form submit and submit asynchronously
const formFinanceiro2 = document.getElementById("formFinanceiro2");
formFinanceiro2.addEventListener("submit", function(event) {
  event.preventDefault(); // Prevent default form submission that causes redirect

  // Gather form data
  const formData = new FormData(formFinanceiro2);

  // Convert to URLSearchParams for x-www-form-urlencoded POST or send as JSON
  // API endpoint expects form post, so send as FormData
  fetch(formFinanceiro2.action, {
    method: formFinanceiro2.method,
    body: formData,
    mode: 'cors'
  }).then(response => {
    if (response.ok) {
      alert("Registrado com sucesso.");
      formFinanceiro2.reset();
      // Optionally hide the form
      boxFinanceiro2.classList.add("hidden");
    } else {
      alert("Erro ao enviar formul√°rio. Tente novamente.");
    }
  }).catch(error => {
    alert("Erro ao enviar formul√°rio. Tente novamente.");
    console.error(error);
  });
});

btnLoadRelatorio.addEventListener("click", () => {
  relatorioContainer.innerHTML = "Carregando...";

  fetch("https://api.sheetbest.com/sheets/8846f338-a3ea-446c-894b-31fc8ada7191")
    .then(res => res.json())
    .then(data => {
      if (!data.length) {
        relatorioContainer.innerHTML = "<p>Nenhum dado encontrado.</p>";
        return;
      }

      // Corrige o formato de m√™s
      data.forEach(i => {
        if (i.MesRef) i.MesRef = i.MesRef.slice(0, 7);
      });

      window.financeiroRelatorioData = data;

// Meses √∫nicos
const meses = [...new Set(data.map(d => d.MesRef).filter(Boolean))].sort().reverse();
const mesSelector = document.getElementById("relatorioMesSelector");
mesSelector.innerHTML = "";
meses.forEach(m => {
  const opt = document.createElement("option");
  opt.value = m;
  opt.textContent = m;
  mesSelector.appendChild(opt);
});

// Pega o m√™s atual no formato YYYY-MM
const mesAtualSistema = new Date().toISOString().slice(0, 7);

// Se existir nos meses dispon√≠veis, usa ele; sen√£o, usa o mais recente da lista
const mesInicial = meses.includes(mesAtualSistema) ? mesAtualSistema : (meses[0] || "");

// Define o valor inicial do seletor e atualiza o dashboard
mesSelector.value = mesInicial;
atualizarDashboard(mesInicial);


      relatorioDiv.classList.remove("hidden");
    })
    .catch(err => {
      console.error(err);
      relatorioContainer.innerHTML = "<p>Erro ao carregar dados.</p>";
    });
});

document.addEventListener("DOMContentLoaded", () => {
  const relatorioContainer = document.getElementById("relatorioContainer");
  const toggleBtn = document.getElementById("toggleRelatorioBtn");
  const btnLoadRelatorio = document.getElementById("btnLoadRelatorio");

  // üß± Garante estado inicial
  if (btnLoadRelatorio) btnLoadRelatorio.style.display = "none"; // esconde bot√£o "Relat√≥rio"
  relatorioContainer.style.display = "none"; // esconde dados
  toggleBtn.style.display = "inline-block"; // mostra o "+"
  toggleBtn.textContent = "+";
  toggleBtn.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
  toggleBtn.style.color = "var(--rose)";

  // üß© Garante que mesmo que outra fun√ß√£o mude o estilo, ele fique oculto no in√≠cio
  setTimeout(() => {
    relatorioContainer.style.display = "none";
  }, 500);

  // üéØ Controle do bot√£o "+ / ‚àí"
  toggleBtn.addEventListener("click", () => {
    const expanded = relatorioContainer.style.display !== "none";
    if (expanded) {
      // Recolhe
      relatorioContainer.style.display = "none";
      toggleBtn.textContent = "+";
      toggleBtn.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
      toggleBtn.style.color = "var(--rose)";
    } else {
      // Expande
      relatorioContainer.style.display = "block";
      toggleBtn.textContent = "‚àí";
      toggleBtn.style.backgroundColor = "rgba(204, 204, 204, 0.3)";
      toggleBtn.style.color = "#111";
    }
  });
});




document.getElementById("relatorioMesSelector").addEventListener("change", (e) => {
  const mes = e.target.value;
  if (window.financeiroRelatorioData) {
    atualizarDashboard(mes);
  }
});


// Add listener for month selector change
function atualizarDashboard(mesSelecionado) {
  // Filter data by selected month "YYYY-MM"
  let filtered = window.financeiroRelatorioData || [];
  if (mesSelecionado) {
filtered = window.financeiroRelatorioData.filter(item => {
  const ref = (item["MesRef"] || "").toString().slice(0, 7);
  return ref === mesSelecionado;
});
  }

  // Aggregate sums grouped by Tipo
  let receita = 0;
  let despesa = 0;
  filtered.forEach(item => {
    const tipo = item["Tipo"];
    const valor = parseFloat(item["Valor"]) || 0;
    if (tipo === "Ganhos") receita += valor;
    else if (tipo === "Despesas") despesa += valor;
  });

  // Format values to BRL currency
  const formataValor = v => "R$" + v.toFixed(2).replace(".", ",");

  document.getElementById("dashboardReceita").textContent = formataValor(receita);
  document.getElementById("dashboardDespesa").textContent = formataValor(despesa);
  document.getElementById("dashboardSaldo").textContent = formataValor(receita - despesa);

  // Build detailed hierarchical summary grouped by Tipo > Familia > Nome
  // const resumoDetalhadoDiv = document.getElementById("relatorioResumoDetalhado");
  // const relatorioContainer = document.getElementById("relatorioContainer");

if (!filtered.length) {
  // Caso n√£o tenha dados, mostra mensagem no resumo e oculta tabela
  resumoDetalhadoDiv.innerHTML = "<p>Sem dados aqui :(</p>";
  relatorioContainer.innerHTML = "";
  resumoDetalhadoDiv.style.display = "block";
  relatorioContainer.style.display = "none";
  return;
} else {
  // Mostra o resumo sempre, mas mant√©m a tabela oculta
  resumoDetalhadoDiv.style.display = "block";
  relatorioContainer.style.display = "none";
}



  resumoDetalhadoDiv.innerHTML = ""; // clear existing content

  // Helper to safely accumulate sums
  const acumulador = {};

  filtered.forEach(item => {
    const tipo = item["Tipo"] || "Sem Tipo";
    const familia = item["Familia"] || "Sem Fam√≠lia";
    const nome = item["Nome"] || "Sem Nome";
    const valor = parseFloat(item["Valor"]) || 0;

    if (!acumulador[tipo]) acumulador[tipo] = { total: 0, familias: {} };
    acumulador[tipo].total += valor;

    if (!acumulador[tipo].familias[familia]) acumulador[tipo].familias[familia] = { total: 0, nomes: {} };
    acumulador[tipo].familias[familia].total += valor;

    if (!acumulador[tipo].familias[familia].nomes[nome]) acumulador[tipo].familias[familia].nomes[nome] = 0;
    acumulador[tipo].familias[familia].nomes[nome] += valor;
  });

  // Helper to create a row with category left and value right with dotted leader
  function createRow(label, value, options = {}) {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.marginBottom = options.marginBottom || "2px";

    // Label container flex
    const labelContainer = document.createElement("div");
    labelContainer.style.display = "flex";
    labelContainer.style.alignItems = "center";
    labelContainer.style.flexGrow = "1";

    const labelSpan = document.createElement("span");
    labelSpan.textContent = label;
    labelSpan.style.fontWeight = options.bold ? "bold" : "normal";
    labelSpan.style.fontStyle = options.italic ? "italic" : "normal";
    labelSpan.style.fontSize = options.fontSize || "1rem";
    labelSpan.style.paddingLeft = options.paddingLeft || "0";
    labelSpan.style.whiteSpace = "nowrap";
    labelSpan.style.zIndex = "1";

    // Dots filler that expands horizontally between label and value
    const dotsSpan = document.createElement("span");
    dotsSpan.style.flexGrow = "1";
    dotsSpan.style.borderBottom = "1px dotted #cccccc";
    dotsSpan.style.margin = "0 6px";

    // Value container fixed width on right
    const valueSpan = document.createElement("span");
    valueSpan.textContent = value;
    valueSpan.style.fontWeight = options.bold ? "bold" : "normal";
    valueSpan.style.whiteSpace = "nowrap";
    valueSpan.style.minWidth = "7ch";
    valueSpan.style.textAlign = "right";

    labelContainer.appendChild(labelSpan);
    labelContainer.appendChild(dotsSpan);

    row.appendChild(labelContainer);
    row.appendChild(valueSpan);

    return row;
  }

  // Iterate over Tipo groups, then Familias, then Nomes, adding subtotal and total lines with separators
  let grandTotal = 0;

  for (const tipoKey in acumulador) {
    const tipoTotal = formataValor(acumulador[tipoKey].total);
    // Add a separator line for Tipo groups except first
    if (resumoDetalhadoDiv.childElementCount > 0) {
      const hr = document.createElement("hr");
      hr.style.border = "none";
      hr.style.borderTop = "1px solid #cccccc";
      hr.style.margin = "10px 0";
      resumoDetalhadoDiv.appendChild(hr);
    }
    resumoDetalhadoDiv.appendChild(createRow(tipoKey.toUpperCase(), tipoTotal, { bold: true, marginBottom: "6px" }));

    const familias = acumulador[tipoKey].familias;
    for (const famKey in familias) {
      const famTotal = formataValor(familias[famKey].total);
      resumoDetalhadoDiv.appendChild(createRow("‚îî " + famKey, famTotal, { fontSize: "0.875rem", paddingLeft: "1rem", marginBottom: "4px" , italic: false}));

      const nomes = familias[famKey].nomes;
      for (const nomeKey in nomes) {
        const nomeTotal = formataValor(nomes[nomeKey]);
      resumoDetalhadoDiv.appendChild(createRow("   ‚îî " + nomeKey, nomeTotal, { fontSize: "0.875rem", paddingLeft: "2rem", marginBottom: "2px", italic: false }));
      }

      // Add Familia subtotal separator line with background
      const famSubtotalContainer = document.createElement("div");
      famSubtotalContainer.style.backgroundColor = "rgba(204, 204, 204, 0.1)";
      famSubtotalContainer.style.padding = "2px 6px";
      famSubtotalContainer.style.marginBottom = "10px";
      famSubtotalContainer.style.borderRadius = "4px";
      
      const famSubtotalHr = document.createElement("hr");
      famSubtotalHr.style.border = "none";
      famSubtotalHr.style.borderTop = "1px dotted #cccccc";
      famSubtotalHr.style.margin = "0 0 0 1rem";
      famSubtotalContainer.appendChild(famSubtotalHr);

      resumoDetalhadoDiv.appendChild(famSubtotalContainer);
    }

    grandTotal += acumulador[tipoKey].total;
  }

  // Add grand total line after all Tipos with background
  const grandTotalContainer = document.createElement("div");
  grandTotalContainer.style.backgroundColor = "rgba(204, 204, 204, 0.2)";
  grandTotalContainer.style.borderRadius = "6px";
  grandTotalContainer.style.padding = "6px 10px";
  grandTotalContainer.style.margin = "12px 0";

  // Removed grand total separator <hr> line as per request
  /*
  const grandTotalHr = document.createElement("hr");
  grandTotalHr.style.border = "none";
  grandTotalHr.style.borderTop = "2px solid #cccccc";
  grandTotalHr.style.margin = "0 0 6px 0";

  grandTotalContainer.appendChild(grandTotalHr);
  */

  grandTotalContainer.appendChild(createRow("TOTAL", formataValor(grandTotal), { bold: true, marginBottom: "0" }));

  resumoDetalhadoDiv.appendChild(grandTotalContainer);

  // Also update the displayed report table to show only filtered data
  // const relatorioContainer = document.getElementById("relatorioContainer");
  relatorioContainer.innerHTML = ""; // clear existing table

  const table = document.createElement("table");
  table.className = "w-full text-left border-collapse";
  table.style.border = "none"; // Remove outer border

  const thead = document.createElement("thead");
  const headerRow = document.createElement("tr");
  // Reduced header cell padding for tighter rows
  const headerCellPadding = "4px 6px";
  

  const keys = Object.keys(filtered[0]);
keys.forEach(key => {
  const th = document.createElement("th");

  // üîπ Renomeia apenas DtRegistro ‚Üí Data
  if (key === "DtRegistro") {
    th.textContent = "Data";
  } else {
    th.textContent = key;
  }

  // üî∏ Centraliza o texto do cabe√ßalho
  th.style.textAlign = "center";

  headerRow.appendChild(th);
});
  thead.appendChild(headerRow);
  table.appendChild(thead);

const tbody = document.createElement("tbody");
const cellPadding = "4px 6px";

// üîπ Dentro do loop que cria as linhas da tabela (tr)
filtered.forEach((row, index) => {
  const tr = document.createElement("tr");
  tr.className = "registro";
  tr.dataset.index = index;

  // üîπ Efeito zebrado: alterna cores entre linhas
  tr.style.backgroundColor = index % 2 === 0 ? "#2d2d2d" : "#3a3a3a"; // contraste mais forte
  tr.style.transition = "background-color 0.3s ease";

  keys.forEach(key => {
    const td = document.createElement("td");
    let valor = row[key];

    // üî∏ Formata DtRegistro ‚Üí DD/MM (sem ano)
    if (key === "DtRegistro" && valor) {
      const [ano, mes, dia] = valor.split("-");
      valor = `${dia}/${mes}`;
    }

    // üî∏ Formata MesRef ‚Üí MM/AA
    if (key === "MesRef" && valor) {
      const [ano, mes] = valor.split("-");
      valor = `${mes}/${ano.slice(2)}`;
    }

    td.textContent = valor || "‚Äî";
    td.style.textAlign = "center";
    td.style.padding = "4px 6px";
    tr.appendChild(td);
  });

  // üîπ Bot√£o de exclus√£o (mant√©m o que j√° tem)
  const tdAcoes = document.createElement("td");
  tdAcoes.style.textAlign = "center";

  const btnExcluir = document.createElement("button");
  btnExcluir.textContent = "üóëÔ∏è";
  btnExcluir.title = "Excluir Registro";
  btnExcluir.style.color = "#ff7373";
  btnExcluir.style.cursor = "pointer";

  btnExcluir.addEventListener("click", async () => {
    if (!confirm("Deseja realmente excluir este registro?")) return;

    try {
      const baseURL = "https://api.sheetbest.com/sheets/8846f338-a3ea-446c-894b-31fc8ada7191";
      const res = await fetch(`${baseURL}?nocache=${Date.now()}`);
      const dados = await res.json();

      const normaliza = str => (str || "").trim().toLowerCase();

      const match = dados.find(d =>
        normaliza(d.DtRegistro) === normaliza(row.DtRegistro) &&
        normaliza(d.Descricao) === normaliza(row.Descricao) &&
        normaliza(d.MesRef) === normaliza(row.MesRef) &&
        parseFloat(d.Valor || 0) === parseFloat(row.Valor || 0)
      );

      if (!match) {
        alert("‚ùå Registro n√£o encontrado na planilha.");
        return;
      }

      const deleteURL = `${baseURL}/DtRegistro/${encodeURIComponent(match.DtRegistro)}`;
      const del = await fetch(deleteURL, { method: "DELETE" });

      if (del.ok) {
        // Efeito fade-out antes de remover
        tr.style.transition = "opacity 0.4s ease";
        tr.style.opacity = "0";
        setTimeout(() => tr.remove(), 400);
        alert("‚úÖ Registro exclu√≠do com sucesso!");
      } else {
        alert("‚ùå Erro ao excluir da planilha.");
      }

    } catch (err) {
      console.error("Erro ao excluir registro:", err);
      alert("‚ùå Erro ao excluir registro. Verifique a conex√£o e tente novamente.");
    }
  });

  tdAcoes.appendChild(btnExcluir);
  tr.appendChild(tdAcoes);
  tbody.appendChild(tr);
});




table.appendChild(tbody);


  relatorioContainer.appendChild(table);
}

async function atualizarResumoFinanceiroHome() {
  try {
    const res = await fetch("https://api.sheetbest.com/sheets/8846f338-a3ea-446c-894b-31fc8ada7191");
    const data = await res.json();

    // Pega o m√™s atual (YYYY-MM)
    const mesAtual = new Date().toISOString().slice(0, 7);

    // Corrige formato dos meses
    data.forEach(i => {
      if (i.MesRef) i.MesRef = i.MesRef.slice(0, 7);
    });

    // Filtra registros do m√™s atual
    const filtrados = data.filter(i => i.MesRef === mesAtual);

    let receita = 0, despesa = 0;
    filtrados.forEach(i => {
      const valor = parseFloat(i.Valor) || 0;
      if (i.Tipo === "Ganhos") receita += valor;
      else if (i.Tipo === "Despesas") despesa += valor;
    });

    const formatar = v => "R$ " + v.toFixed(2).replace(".", ",");

    // Atualiza a UI
    document.querySelector("#resumoReceita p").textContent = formatar(receita);
    document.querySelector("#resumoDespesa p").textContent = formatar(despesa);
    document.querySelector("#resumoSaldo p").textContent = formatar(receita - despesa);

  } catch (err) {
    console.error("Erro ao atualizar resumo financeiro:", err);
  }
}

// Atualiza quando a p√°gina carrega
document.addEventListener("DOMContentLoaded", atualizarResumoFinanceiroHome);

</script>

</main>

<script>

const SHEET_CLIENTES_URL = "https://api.sheetbest.com/sheets/8846f338-a3ea-446c-894b-31fc8ada7191/tabs/Cadastros";

// ‚úÖ Salvar cliente na planilha SheetBest
async function salvarClienteSheet(cliente) {
  try {
    const response = await fetch(SHEET_CLIENTES_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(cliente),
    });
    if (!response.ok) throw new Error("Erro ao salvar cliente.");
    alert("‚úÖ Cliente registrado com sucesso!");
    carregarClientes();
  } catch (error) {
    console.error("Erro ao registrar cliente:", error);
    alert("‚ùå Erro ao registrar cliente na planilha.");
  }
}

async function excluirClientePlanilha(nome) {
  if (!nome) return alert("Nome inv√°lido.");
  if (!confirm(`Tem certeza que deseja excluir "${nome}" da planilha?`)) return;

  const baseURL = "https://api.sheetbest.com/sheets/8846f338-a3ea-446c-894b-31fc8ada7191/tabs/Cadastros";

  try {
    // Normaliza texto
    const normaliza = (str) =>
      (str || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim()
        .toLowerCase();

    // Busca inicial sem cache
    const res = await fetch(`${baseURL}?nocache=${Date.now()}`, { cache: "no-store" });
    const data = await res.json();

    const cliente = data.find((c) => normaliza(c.Nome) === normaliza(nome));
    if (!cliente) {
      alert(`‚ùå Cliente "${nome}" n√£o encontrado.`);
      return;
    }

    // Remove visualmente da tela
    const cards = document.querySelectorAll("#listaClientes > div");
    cards.forEach(card => {
      if (card.innerText.toLowerCase().includes(nome.toLowerCase())) {
        card.style.transition = "opacity 0.4s ease";
        card.style.opacity = "0";
        setTimeout(() => card.remove(), 400);
      }
    });

    // Exclui na planilha
    const deleteURL = `${baseURL}/Nome/${encodeURIComponent(cliente.Nome)}`;
    const delRes = await fetch(deleteURL, { method: "DELETE" });
    if (!delRes.ok) throw new Error("Falha ao excluir.");

    alert(`‚úÖ Cliente "${nome}" exclu√≠do.`);

  } catch (err) {
    console.error("Erro ao excluir cliente:", err);
    alert("‚ùå Erro ao excluir cliente. Verifique a conex√£o e tente novamente.");
  }
}





async function editarCliente(nome) {
  try {
    const res = await fetch(SHEET_CLIENTES_URL);
    const data = await res.json();

    // Localiza o cliente pelo nome
    const cliente = data.find(c => c.Nome?.trim().toLowerCase() === nome.trim().toLowerCase());
    if (!cliente) return alert("Cliente n√£o encontrado.");

    // Preenche os campos
    document.getElementById("clienteNome").value = cliente.Nome || "";
    document.getElementById("clienteCpf").value = cliente.CPF || "";
    document.getElementById("clienteTelefone").value = cliente.Telefone || "";
    document.getElementById("clienteDn").value = cliente.DN || "";
    document.getElementById("clienteEnderecoNum").value = cliente.Endereco || "";
    document.getElementById("clienteCep").value = cliente.CEP || "";
    document.getElementById("clienteInstagram").value = cliente.Instagram || "";
    document.getElementById("clienteStatus").value = cliente.Status || "Ativo";

    // Mostra o formul√°rio e altera o t√≠tulo
    document.getElementById("boxCliente").classList.remove("hidden");
    document.getElementById("tituloCliente").textContent = "Editar Cliente";

    // Guarda o nome original para salvar depois
    window.clienteEditando = cliente.Nome;

  } catch (err) {
    console.error("Erro ao editar cliente:", err);
    alert("Erro ao carregar dados para edi√ß√£o.");
  }
}


// ‚úÖ Carregar clientes
async function carregarClientes() {
  const container = document.getElementById("listaClientes");
  container.innerHTML = "<p class='text-center text-rose-300'>Carregando...</p>";

  try {
    const res = await fetch(SHEET_CLIENTES_URL);
    const data = await res.json();

    if (!data.length) {
      container.innerHTML = "<p class='text-center text-rose-300'>Nenhum cliente cadastrado.</p>";
      return;
    }

    const filtro = document.querySelector('input[name="filtroStatus"]:checked')?.value || "todos";

    const clientes = data
      .filter((c) => c.Nome && c.Nome.trim() !== "")
      .map((c) => ({
        nome: c.Nome,
        cpf: c.CPF,
        telefone: c.Telefone,
        dn: c.DN,
        endereco: c.Endereco,
        cep: c.CEP,
        instagram: c.Instagram,
        status: (c.Status || "").toLowerCase(),
      }))
      .filter((c) => filtro === "todos" || c.status === filtro.toLowerCase());

    if (!clientes.length) {
      container.innerHTML = "<p class='text-center text-rose-300'>Nenhum cliente com este status.</p>";
      return;
    }

    container.innerHTML = "";
// üîπ Busca todos os registros da aba "Cadastros" apenas uma vez
const API_CADASTROS = "https://api.sheetbest.com/sheets/8846f338-a3ea-446c-894b-31fc8ada7191/tabs/Cadastros";
let cadastrosData = [];
try {
  const resCad = await fetch(`${API_CADASTROS}?nocache=${Date.now()}`);
  cadastrosData = await resCad.json();
} catch (err) {
  console.error("Erro ao buscar dados de Cadastros:", err);
}

container.innerHTML = "";

clientes.forEach((cli) => {
  // --- üîπ Fun√ß√£o para formatar data e calcular idade ---
  function formatarDataEIdade(dataStr) {
    if (!dataStr) return "";
    const data = new Date(dataStr);
    if (isNaN(data)) return dataStr;
    const dia = String(data.getDate()).padStart(2, "0");
    const mes = String(data.getMonth() + 1).padStart(2, "0");
    const ano = String(data.getFullYear()).slice(-2);
    const hoje = new Date();
    let idade = hoje.getFullYear() - data.getFullYear();
    const m = hoje.getMonth() - data.getMonth();
    if (m < 0 || (m === 0 && hoje.getDate() < data.getDate())) idade--;
    //return `${dia}/${mes}/${ano} - ${idade} anos`;
        return `${idade} anos`;

  }

  // --- üîπ Define cor do status ---
  const isAtivo = (cli.status || "").toLowerCase() === "ativo";
  const corStatus = isAtivo
    ? "bg-green-200 text-green-900"
    : "bg-red-400 text-[#1e1e1e]";

  // --- üîπ IDs √∫nicos ---
  const idTipo = `tipo-${cli.nome.replace(/\s+/g, "-")}`;
  const idData = `data-${cli.nome.replace(/\s+/g, "-")}`;

  // --- üîπ Monta card ---
  const card = document.createElement("div");
  card.className =
  "cliente-card flex items-center text-[#f5c5b5] rounded-2xl p-4 w-full max-w-5xl mx-auto mb-4"
  card.innerHTML = `
<div class="w-12 h-12 flex items-center justify-center rounded-full mr-4 shadow-md"
     style="background: linear-gradient(135deg, #b88c7a, #f4bfae); color: white; font-weight: 700; font-size: 1.50rem;">
  ${cli.nome.charAt(0).toUpperCase()}
</div>

         <div class="flex flex-col justify-center flex-1 border border-transparent rounded-md p-0.5">
        <div class="flex items-center gap-2 mb-1">
        <h2 class="font-semibold text-xl">${cli.nome}</h2>
         <span class="${corStatus} text-xs font-semibold px-2 py-0.5 rounded-md">${cli.status}</span>
         </div>
        <div class="grid grid-cols-2 gap-x-6 items-center">
        <div class="flex flex-col justify-center text-xs text-left">
          <p class="italic">@${cli.instagram || "instagram"}</p>
          <p><i class="fas fa-phone mr-1"></i>${cli.telefone || "-"}</p>
          <p>${cli.endereco || ""}</p>
        </div>
        <div class="flex flex-col justify-center text-xs italic text-right">
          <p>${formatarDataEIdade(cli.dn)}</p>
          <p>${cli.dn || ""}</p>
        </div>
      </div>
    </div>

<div class="flex flex-col items-center rounded-md p-2 ml-4 shadow-inner" 
     style="
     width:150px; background-color:rgba(50,50,50,0.08); backdrop-filter:blur(2px); border:1px solid rgba(89,89,89,0.15);
              background-color:#2b2b2b;
         background-image: radial-gradient(#3a3a3a 1px, transparent 1px);
         background-size:6px 6px;
         border:1px solid #3a3a3a;
     ">
  
<!-- Caixa t√≠tulo com fundo pontilhado -->
<div class="font-semibold text-xs rounded-md px-3 py-1 mb-1 shadow-sm whitespace-nowrap w-full text-center"
     style="
       color:#f5c5b5;
     ">
  Agendamentos
</div>

  <!-- Caixa de informa√ß√µes com fundo pontilhado -->
  <div class="border-2 rounded-md px-3 py-2 text-center text-xs whitespace-nowrap w-full shadow-sm"
       style="
         border-color:#3a3a3a;
         background-color:#2b2b2b;
         background-size:6px 6px;
       ">
    <p id="${idTipo}" class="font-semibold text-[#f5c5b5]">Carregando...</p>
    <p id="${idData}" class="text-[#f5c5b5]">--/--/----</p>
  </div>
</div>


    <div class="flex flex-col justify-center items-center gap-2 ml-4">
      <button class="text- hover:text-green-300" 
        onclick="window.open('https://wa.me/55${cli.telefone.replace(/\D/g,'')}', '_blank')">
        <i class="fab fa-whatsapp text-lg"></i>
      </button>
      <button class="text- hover:text-yellow-800" onclick="editarCliente('${cli.nome}')">
        <i class="fas fa-edit text-lg"></i>
      </button>
      <button class="text- hover:text-red-400" onclick="excluirClientePlanilha('${cli.nome}')">
        <i class="fas fa-trash text-lg"></i>
      </button>
    </div>
  `;


  // üîπ Cria a faixa rosa expans√≠vel
//const footer = document.createElement("div");
//footer.className = "card-footer";

// üîπ Conte√∫do que aparece dentro da faixa quando expandida
//const footerContent = document.createElement("div");
//footerContent.className = "card-footer-content";
//footerContent.innerHTML = `
  //<p><strong>√öltimo Atendimento:</strong> ${cli.ultimoAtend || "‚Äî"}</p>
  //<p><strong>Tipo Pr√≥x. Atendimento:</strong> ${cli.tipoProxAtend || "‚Äî"}</p>
  //<p><strong>Data Pr√≥x. Atendimento:</strong> ${cli.dtProxAtend || "‚Äî"}</p>
  //<p><strong>Observa√ß√µes:</strong> ${cli.obs || "Nenhuma observa√ß√£o."}</p>
//`;

//footer.appendChild(footerContent);

// üîπ A√ß√£o de abrir e fechar
//footer.addEventListener("click", () => {
//  footer.classList.toggle("open");
//});

container.appendChild(card);
//container.appendChild(footer);


  // --- üîπ Associa TipoProxAtend e DtProxAtend ---
  const normaliza = (txt) =>
    (txt || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toLowerCase();

  const match = cadastrosData.find(
    (item) => normaliza(item.Nome) === normaliza(cli.nome)
  );

if (match) {
  document.getElementById(idTipo).textContent = match.TipoProxAtend || "-";
  document.getElementById(idData).textContent = match.DtProxAtend || "Sem Agendamento";

  // üîπ Cor padr√£o (rosa clara)
  document.getElementById(idTipo).style.color = "#f5c5b5";
  document.getElementById(idData).style.color = "#f5c5b5";
} else {
  document.getElementById(idTipo).textContent = "Sem agendamento";
  document.getElementById(idData).textContent = "‚Äî";

  // üî∏ Fica amarelo quando n√£o h√° agendamento
  document.getElementById(idTipo).style.color = "#ffd966";
  document.getElementById(idData).style.color = "#ffd966";
}

});

  } catch (err) {
    console.error("Erro ao carregar clientes:", err);
    container.innerHTML = "<p class='text-center text-red-400'>Erro ao carregar dados.</p>";
  }
}

// ‚úÖ Enviar cliente (substitui localStorage)
document.getElementById("formCliente").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const cliente = Object.fromEntries(formData.entries());

  // Se for edi√ß√£o
  if (window.clienteEditando) {
    try {
      const url = `${SHEET_CLIENTES_URL}/Nome/${encodeURIComponent(window.clienteEditando)}`;
      const response = await fetch(url, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(cliente),
      });
      if (!response.ok) throw new Error("Erro ao atualizar cliente.");
      alert("‚úÖ Cliente atualizado com sucesso!");
      delete window.clienteEditando;
      carregarClientes();
    } catch (err) {
      console.error("Erro ao atualizar cliente:", err);
      alert("‚ùå Erro ao salvar altera√ß√µes.");
    }
  } else {
    // Novo cadastro
    salvarClienteSheet(cliente);
  }

  e.target.reset();
  document.getElementById("boxCliente").classList.add("hidden");
});


// Atualiza automaticamente quando o filtro muda
document.querySelectorAll('input[name="filtroStatus"]').forEach(radio => {
  radio.addEventListener("change", carregarClientes);
});


document.addEventListener("DOMContentLoaded", function() {
    // L√≥gica para mostrar/esconder o formul√°rio dentro do bot√£o
  const btnAnamnese = document.getElementById("btnAnamnese");
  const boxAnamnese = document.getElementById("boxAnamnese");
  btnAnamnese.addEventListener("click", function(e) {
    e.stopPropagation();
    boxAnamnese.classList.toggle("hidden");
  });
  document.addEventListener("click", function(e) {
    if (!boxAnamnese.classList.contains("hidden")) {
      const isClickInside = boxAnamnese.contains(e.target) || btnAnamnese.contains(e.target);
      if (!isClickInside) boxAnamnese.classList.add("hidden");
    }
  });
  document.getElementById("fecharBoxAnamnese").addEventListener("click", function() {
    boxAnamnese.classList.add("hidden");
  });

  // Add toggle for Ocorr√™ncia form similar to Anamnese and Clientes
  const btnAdicionarOcorrencia = document.getElementById("btnAdicionarOcorrencia");
  const boxFinanceiro2 = document.getElementById("boxFinanceiro2");
  btnAdicionarOcorrencia.addEventListener("click", function(e) {
    e.stopPropagation();
    boxFinanceiro2.classList.toggle("hidden");
  });
  document.addEventListener("click", function(e) {
    if (!boxFinanceiro2.classList.contains("hidden")) {
      const isClickInside = boxFinanceiro2.contains(e.target) || btnAdicionarOcorrencia.contains(e.target);
      if (!isClickInside) boxFinanceiro2.classList.add("hidden");
    }
  });
  document.getElementById("fecharBoxFinanceiro2").addEventListener("click", function() {
    boxFinanceiro2.classList.add("hidden");
  });
    document.getElementById("formAnamneseBox").addEventListener("submit", function(e) {
      e.preventDefault();
      alert("‚úÖ Anamnese salva!");
      boxAnamnese.classList.add("hidden");
      this.reset();
    });
    // L√≥gica para mostrar/esconder o formul√°rio de cliente
    const btnAdicionarCliente = document.getElementById("btnAdicionarCliente");
    const boxCliente = document.getElementById("boxCliente");
    btnAdicionarCliente.addEventListener("click", function(e) {
      e.stopPropagation();
      editingIndex = -1;
      document.getElementById('formCliente').reset();
      document.getElementById('tituloCliente').textContent = 'Cadastro de Cliente';
      boxCliente.classList.toggle("hidden");
    });
    document.addEventListener("click", function(e) {
      if (!boxCliente.classList.contains("hidden")) {
        const isClickInside = boxCliente.contains(e.target) || btnAdicionarCliente.contains(e.target);
        if (!isClickInside) boxCliente.classList.add("hidden");
      }
    });
    document.getElementById("fecharBoxCliente").addEventListener("click", function() {
      boxCliente.classList.add("hidden");
    });
    document.getElementById("formCliente").addEventListener("submit", function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const cliente = {
        nome: formData.get('nome'),
        cpf: formData.get('cpf'),
        telefone: formData.get('telefone'),
        dn: formData.get('dn'),
        endereco_num: formData.get('endereco_num'),
        cep: formData.get('cep'),
        instagram: formData.get('instagram'),
        status: formData.get('status')
      };
      salvarCliente(cliente);
      alert("‚úÖ Cliente salvo!");
      boxCliente.classList.add("hidden");
      this.reset();
      carregarClientes();
    });

  const sidebar = document.getElementById("sidebar");
  const menuBtn = document.getElementById("menuBtn");
  menuBtn.addEventListener("click", function(e) {
    sidebar.classList.toggle("hidden");
    e.stopPropagation();
  });

  // Fecha o menu ao clicar fora da sidebar ou do bot√£o
  document.addEventListener("click", function(e) {
    if (!sidebar.classList.contains("hidden")) {
      const isClickInsideSidebar = sidebar.contains(e.target);
      const isClickOnMenuBtn = menuBtn.contains(e.target);
      if (!isClickInsideSidebar && !isClickOnMenuBtn) {
        sidebar.classList.add("hidden");
      }
    }
  });
  const pages = document.querySelectorAll(".page");
  document.querySelectorAll(".sidebar a").forEach(a=>{
    a.addEventListener("click", e=>{
      e.preventDefault();
      pages.forEach(p=>p.classList.add("hidden"));
      document.getElementById(a.dataset.page+"Page").classList.remove("hidden");
      document.querySelectorAll(".sidebar a").forEach(x=>x.classList.remove("active"));
      a.classList.add("active");
      if(a.dataset.page==="clientes") carregarClientes();
      if(a.dataset.page==="home") renderHomeCalendar();
if (a.dataset.page === "financeiro2") {
  const btnLoadRelatorio = document.getElementById("btnLoadRelatorio");
  const relatorioContainer = document.getElementById("relatorioContainer");
  const toggleBtn = document.getElementById("toggleRelatorioBtn");
  const mesSelector = document.getElementById("relatorioMesSelector");

  // üîπ Garante estado inicial
  relatorioContainer.style.display = "none"; // relat√≥rio oculto
  toggleBtn.style.display = "inline-block";
  toggleBtn.textContent = "+";
  toggleBtn.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
  toggleBtn.style.color = "var(--rose)";

  // üîπ Esconde o bot√£o de carregar relat√≥rio
  if (btnLoadRelatorio) btnLoadRelatorio.style.display = "none";

  // üîπ Carrega os dados da planilha silenciosamente
  fetch("https://api.sheetbest.com/sheets/8846f338-a3ea-446c-894b-31fc8ada7191")
    .then(res => res.json())
    .then(data => {
      if (!data.length) return;

      // Corrige formato do m√™s
      data.forEach(i => {
        if (i.MesRef) i.MesRef = i.MesRef.slice(0, 7);
      });

      // Guarda globalmente
      window.financeiroRelatorioData = data;

      // Pega meses √∫nicos
      const meses = [...new Set(data.map(d => d.MesRef).filter(Boolean))].sort().reverse();
      mesSelector.innerHTML = "";
      meses.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        mesSelector.appendChild(opt);
      });

      // Pega o m√™s atual
      const mesAtual = new Date().toISOString().slice(0, 7);
      const mesInicial = meses.includes(mesAtual) ? mesAtual : meses[0];
      mesSelector.value = mesInicial;

      // üîπ Atualiza o dashboard e os resumos com o m√™s atual
      if (typeof atualizarDashboard === "function") atualizarDashboard(mesInicial);
      if (typeof atualizarResumoFinanceiroHome === "function") atualizarResumoFinanceiroHome();
    })
    .catch(err => console.error("Erro ao carregar relat√≥rio:", err));
}


    });
  });

  let homeCalendar;
  function renderHomeCalendar() {
    const calendarEl = document.getElementById("calendar");
    if (!calendarEl) return;
    if (homeCalendar) {
      homeCalendar.destroy();
    }
    homeCalendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      dateClick: info => {
        const nome = prompt("Nome do Cliente:");
        if (nome) addAgendamento(info.dateStr, nome);
      }
    });
    homeCalendar.render();
  }
  renderHomeCalendar();

  const agendaCalendar = new FullCalendar.Calendar(document.getElementById("calendarAgenda"), {
    initialView:"dayGridMonth"
  });
  agendaCalendar.render();

  async function addAgendamento(data, cliente){
    const agendamento={tipo:"agendamento",data,hora:"09:00",cliente,servico:"C√≠lios"};
    await fetch(API_URL,{method:"POST",body:JSON.stringify(agendamento),headers:{"Content-Type":"application/json"}});
    alert("‚úÖ Agendamento salvo!");
    atualizarHome();
  }

  async function atualizarHome(){
    const res=await fetch(API_URL);
    const data=await res.json();
    document.getElementById("atendimentos").innerText=`Atendimentos: ${data.agendamentos?.length||0}`;
  }
});

function handleFinanceiro2Submit(event) {
  event.preventDefault();
  alert("Registrado com sucesso.");
  return false; // prevent default form submission to stay on page
}
</script>
</body>
</script>
